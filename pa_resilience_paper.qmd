---
title: "Panama Resilience Paper"
author: Cob Staines
date: 2025-10-09
format:
  html:
    toc: true
df-print: kable
---
# Objective

Illustrate differences in Bd prevalence and load across Panamanian species.

## Setup

```{r}
#| eval: true
#| output: false
#| code-fold: true
#| code-summary: "Show setup code"

# setup
librarian::shelf(tidyverse, dbplyr, here, janitor, RPostgres, DBI, RIBBiTR-BII/ribbitrrr, brms, tidybayes, ggplot2, emmeans)

## Connect to DB
dbcon = hopToDB("ribbitr", hopReg = FALSE)

# table pointers
db_bd = tbl(dbcon, Id("survey_data", "bd_qpcr_results"))
db_sample = tbl(dbcon, Id("survey_data", "sample"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_visit = tbl(dbcon, Id("survey_data", "visit"))
db_site = tbl(dbcon, Id("survey_data", "site"))
db_region = tbl(dbcon, Id("survey_data", "region"))
db_country = tbl(dbcon, Id("survey_data", "country"))

bd_sample = db_sample %>%
  right_join(db_capture, by = "capture_id") %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by = "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  filter(sample_type == "bd")
```
## Data selection

### Classification by season (maybe, maybe not)
The data were classified into two seasons:

  - **Lluvia (wet)**: May - August
  - **Seca (dry)**: October - January
  
### Species selection criteria:
Species were were included if at least 30 individuals with Bd swabs were present for that species.


```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Show data collection code"

# define life_stage_simple by SVL
bd_population = bd_sample %>%
  # filter(!is.na(svl_mm) | !is.na(body_mass_g)) %>%
  filter(country == "panama",
         !(life_stage %in% c("eggmass", "tadpole")),
         !is.na(svl_mm)) %>%
  mutate(population = region,
         tax_pop = paste0(taxon_capture, "_", population),
         year = year(date),
         life_stage_simple = case_when(
           # Savage 1972 & Crump 1988
           ((taxon_capture == "atelopus_varius") & (svl_mm >= 25)) ~ "adult",
           ((taxon_capture == "atelopus_varius") & (svl_mm < 25)) ~ "subadult",
           # Lynch and Myers 1983
           ((taxon_capture == "craugastor_crassidigitus") & (svl_mm >= 20.2)) ~ "adult",
           ((taxon_capture == "craugastor_crassidigitus") & (svl_mm < 20.2)) ~ "subadult",
           # Lynch and Myers 1983
           ((taxon_capture == "craugastor_fitzingeri") & (svl_mm >= 23.5)) ~ "adult",
           ((taxon_capture == "craugastor_fitzingeri") & (svl_mm < 23.5)) ~ "subadult",
           # Amphibiaweb
           ((taxon_capture == "colostethus_panamansis") & (svl_mm >= 18.8)) ~ "adult",
           ((taxon_capture == "colostethus_panamansis") & (svl_mm < 18.8)) ~ "subadult",
           # Leenders 2001
           ((taxon_capture == "dendrobates_auratus") & (svl_mm >= 25)) ~ "adult",
           ((taxon_capture == "dendrobates_auratus") & (svl_mm < 25)) ~ "subadult",
           # Amphibiaweb
           ((taxon_capture == "espadarana_prosoblepon") & (svl_mm >= 21)) ~ "adult",
           ((taxon_capture == "espadarana_prosoblepon") & (svl_mm < 21)) ~ "subadult",
           # Basante 2025
           ((taxon_capture == "lithobates_warszewitschii") & (svl_mm >= 35)) ~ "adult",
           ((taxon_capture == "lithobates_warszewitschii") & (svl_mm < 35)) ~ "subadult",
           # Wang 2008
           ((taxon_capture == "pristimantis_ridens") & (svl_mm >= 16)) ~ "adult",
           ((taxon_capture == "pristimantis_ridens") & (svl_mm < 16)) ~ "subadult",
           # Savage 2002
           ((taxon_capture == "rhaebo_haematiticus") & (svl_mm >= 42)) ~ "adult",
           ((taxon_capture == "rhaebo_haematiticus") & (svl_mm < 42)) ~ "subadult",
           # Easteal 1963
           ((taxon_capture == "rhinella_marina") & (svl_mm >= 85)) ~ "adult",
           ((taxon_capture == "rhinella_marina") & (svl_mm < 85)) ~ "subadult",
           # Savage 2002
           ((taxon_capture == "sachatamia_albomaculata") & (svl_mm >= 20.5)) ~ "adult",
           ((taxon_capture == "sachatamia_albomaculata") & (svl_mm < 20.5)) ~ "subadult",
           # Ibunez & Smith 1995
           ((taxon_capture == "silverstoneia_flotator") & (svl_mm >= 15.1)) ~ "adult",
           ((taxon_capture == "silverstoneia_flotator") & (svl_mm < 15.1)) ~ "subadult",
           # Grant & Myers 2013
           ((taxon_capture == "silverstoneia_nubicola") & (svl_mm >= 15.4)) ~ "adult",
           ((taxon_capture == "silverstoneia_nubicola") & (svl_mm < 15.4)) ~ "subadult",
           # Duellman, W. E. 2001
           ((taxon_capture == "smilisca_sila") & (svl_mm >= 31.6)) ~ "adult",
           ((taxon_capture == "smilisca_sila") & (svl_mm < 31.6)) ~ "subadult",
           .default = NA_character_
         ))

drop_sites = c("alleman",
               "el_valle_hotel",
               "farallon",
               "gamboa",
               "juan_lana",
               "rana_dorada",
               "sora")

# identify valid species & seasons
bd_species_valid = bd_population %>%
  mutate(year = year(date),
         month = month(date),
         season = case_match(month,
                             c(5, 6, 7, 8) ~ "lluvia",
                             c(10, 11, 12, 1) ~ "seca",
                             .default = NA_character_)) %>%
  filter(!is.na(taxon_capture),
         # !is.na(season),
         !is.na(life_stage_simple),
         !(site %in% drop_sites),
         year != 2017) %>%
  group_by(taxon_capture) %>%
  summarise(count = n(),
            .groups = "drop") %>%
  filter(count >= 30) %>%
  arrange(desc(count)) %>%
  collect()



# identify valid samples
bd_sample_valid = bd_population %>%
  mutate(year = year(date),
         month = month(date),
         season = case_match(month,
                             c(5, 6, 7, 8) ~ "lluvia",
                             c(10, 11, 12, 1) ~ "seca",
                             .default = NA_character_)) %>%
  inner_join(bd_species_valid %>%
               select("taxon_capture"), by = c("taxon_capture"), copy = TRUE) %>%
  filter(!is.na(life_stage_simple),
         !(site %in% drop_sites),
         year != 2017) %>%
  inner_join(db_bd %>%
              filter(!is.na(detected)) %>%
              group_by(sample_id) %>%
              slice_sample(n = 1) %>%
              ungroup() %>%
              select(sample_id,
                     detected,
                     bd_its1_copies_per_swab),
            by = "sample_id") %>%
  select(sample_id,
         detected,
         bd_its1_copies_per_swab,
         sample_name,
         capture_id,
         taxon_capture,
         life_stage,
         life_stage_simple,
         svl_mm,
         body_mass_g,
         sex,
         observers_survey,
         photo,
         photo_id,
         survey_id,
         start_timestamp_utc,
         date,
         season,
         transect,
         site,
         site_id,
         geographic_area,
         population,
         tax_pop,
         region,
         country) %>%
  collect()

# final data selection and cleaning for model
bd_model = bd_sample_valid %>%
  filter(!is.na(bd_its1_copies_per_swab),
         !is.na(svl_mm)) %>%
  rename(bd_load = bd_its1_copies_per_swab,
         bd_detected = detected) %>%
  mutate(log_bd_load = log(bd_load),
         bd_positive_load = if_else(bd_load > 0, bd_load, NA),
         log_bd_positive_load = log(bd_positive_load)) %>%
  select(bd_load,
         log_bd_load,
         bd_positive_load,
         log_bd_positive_load,
         bd_detected,
         svl_mm,
         transect,
         observers_survey,
         photo,
         photo_id,
         site,
         population,
         taxon_capture,
         tax_pop,
         life_stage,
         life_stage_simple,
         date,
         season,
         population,
         region,
         country)

head(bd_model)
```

## Descriptive stats of data
```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Show selected data stats code"

(bd_model_stats = bd_model %>%
  filter(!is.na(season)) %>%
  group_by(taxon_capture, country, season) %>%
  summarise(regions = paste(sort(unique(region)), collapse = ", "),
            population_n = n_distinct(population),
            site_n = n_distinct(site),
            year_first = year(min(date)),
            year_last = year(max(date)),
            year_count = n_distinct(year(date)),
            adult_n = sum(life_stage_simple == "adult"),
            subadult_n = sum(life_stage_simple == "subadult"),
            .groups = "drop") %>%
  arrange(country,
          taxon_capture))

# descriptive stats
data_stats = bd_model %>%
  mutate(year = year(date)) %>%
  group_by(site, taxon_capture, year) %>%
  summarise(n_bd_swabs = n(),
            .groups = "drop")

data_stats_species = bd_model %>%
  group_by(taxon_capture, region) %>%
  summarize(adult_n = sum(life_stage_simple == "adult"),
            subadult_n = sum(life_stage_simple == "subadult"),
            .groups = "drop")

data_grid_site_year = bd_model %>%
  mutate(year = year(date)) %>%
  group_by(site, year) %>%
  summarise(n_bd_swabs = n(),
            .groups = "drop") %>%
  arrange(year, site) %>%
  pivot_wider(names_from = "year",
              values_from = "n_bd_swabs") %>%
  arrange(site)

data_grid_site_species = bd_model %>%
  mutate(year = year(date)) %>%
  group_by(site, taxon_capture) %>%
  summarise(n_bd_swabs = n(),
            .groups = "drop") %>%
  arrange(taxon_capture, site) %>%
  pivot_wider(names_from = "taxon_capture",
              values_from = "n_bd_swabs")

data_grid_species_year = bd_model %>%
  mutate(year = year(date)) %>%
  group_by(year, taxon_capture) %>%
  summarise(n_bd_swabs = n(),
            .groups = "drop") %>%
  arrange(taxon_capture, year) %>%
  pivot_wider(names_from = "year",
              values_from = "n_bd_swabs")

nubi_data = bd_model %>%
  filter(taxon_capture == "silverstoneia_nubicola") %>%
  arrange(region, site, date) %>%
  select(region,
         site,
         date,
         observers_survey,
         photo_id,
         everything())

```
# Observations
## Process observations
```{r}
get_species_name = function(taxon) {
  species_name = str_to_sentence(gsub("_", " ", taxon))
}

wilson_ci = function(p_hat, n, conf.level = 0.95) {
  z <- qnorm(1 - (1 - conf.level) / 2)
  
  denominator <- 1 + (z^2 / n)
  centre_adjusted_probability <- p_hat + (z^2 / (2 * n))
  adjusted_standard_deviation <- sqrt((p_hat * (1 - p_hat) / n) + (z^2 / (4 * n^2)))
  
  lower_bound <- (centre_adjusted_probability - z * adjusted_standard_deviation) / denominator
  upper_bound <- (centre_adjusted_probability + z * adjusted_standard_deviation) / denominator
  
  return(c(lower_bound = lower_bound, upper_bound = upper_bound))
}

wilson_ci_lower = function(p_hat, n, conf.level = 0.95) {
  ws = wilson_ci(p_hat, n, conf.level)
  return(ws[1])
}

wilson_ci_upper = function(p_hat, n, conf.level = 0.95) {
  ws = wilson_ci(p_hat, n, conf.level)
  return(ws[2])
}

sample_stats = function(obs) {
  obs %>%
    group_by(taxon_capture) %>%
    summarise(n = n(),
              n_pos = sum(bd_load > 0),
              bd_prevalence = sum(bd_load > 0) / n(),
              bd_prevalence_ci_lower = wilson_ci_lower(bd_prevalence, n(), 0.95),
              bd_prevalence_ci_upper = wilson_ci_upper(bd_prevalence, n(), 0.95),
              min_log_load_inf = min(log_bd_load[bd_load > 0]),
              q_25_log_load_inf = quantile(log_bd_load[bd_load > 0], probs = 0.25),
              q_50_log_load_inf = quantile(log_bd_load[bd_load > 0], probs = 0.50),
              q_75_log_load_inf = quantile(log_bd_load[bd_load > 0], probs = 0.75),
              max_log_load_inf = max(log_bd_load[bd_load > 0]),
              se = sqrt(bd_prevalence*(1-bd_prevalence)/n),
              .groups = "drop")
}


obs_stats_all = sample_stats(bd_model) %>%
  mutate(taxon_capture = get_species_name(taxon_capture))

obs_stats_adult = sample_stats(bd_model %>%
                                 filter(life_stage_simple == "adult")) %>%
  mutate(taxon_capture = get_species_name(taxon_capture))

ccdf_zeros = obs_stats_all %>%
  select(taxon_capture) %>%
  distinct() %>%
  mutate(log_bd_load = 20,
         ccdf = 0)

ccdf_all = bd_model %>%
  mutate(taxon_capture = get_species_name(taxon_capture),
         density = 1) %>%
  arrange(taxon_capture, desc(log_bd_load)) %>%
  group_by(taxon_capture) %>%
  mutate(n = n(),
         p = cumsum(density)) %>%
  ungroup() %>%
  group_by(taxon_capture, bd_detected)

ccdf_extended_all = ccdf_all %>%
  filter(!(bd_detected == FALSE) | row_number() == 1) %>%
  ungroup() %>%
  mutate(p = if_else(log_bd_load == -Inf, p - 1, p),
         log_bd_load = if_else(log_bd_load == -Inf, log(0.3), log_bd_load),
         ccdf = p / n) %>%
  bind_rows(ccdf_zeros) %>%
  arrange(taxon_capture, desc(log_bd_load)) %>%
  group_by(taxon_capture) %>%
  mutate(
    ksmooth_result = list(ksmooth(x = log_bd_load,
                                  y = ccdf,
                                  x.points = log_bd_load,
                                  kernel = "normal",
                                  bandwidth = 1)),
    ccdf_x = ksmooth_result[[1]]$x,
    ccdf_y = ksmooth_result[[1]]$y
  ) %>%
  ungroup() %>%
  select(-ksmooth_result)

ccdf_adult = bd_model %>%
  filter(life_stage_simple == "adult") %>%
  mutate(taxon_capture = get_species_name(taxon_capture),
         density = 1) %>%
  arrange(taxon_capture, desc(log_bd_load)) %>%
  group_by(taxon_capture) %>%
  mutate(n = n(),
         p = cumsum(density)) %>%
  ungroup() %>%
  group_by(taxon_capture, bd_detected)

ccdf_extended_adult = ccdf_adult %>%
  filter(!(bd_detected == FALSE) | row_number() == 1) %>%
  ungroup() %>%
  mutate(p = if_else(log_bd_load == -Inf, p - 1, p),
         log_bd_load = if_else(log_bd_load == -Inf, log(0.3), log_bd_load),
         ccdf = p / n) %>%
  bind_rows(ccdf_zeros) %>%
  arrange(taxon_capture, desc(log_bd_load)) %>%
  group_by(taxon_capture) %>%
  mutate(
    ksmooth_result = list(ksmooth(x = log_bd_load,
                                  y = ccdf,
                                  x.points = log_bd_load,
                                  kernel = "normal",
                                  bandwidth = 1)),
    ccdf_x = ksmooth_result[[1]]$x,
    ccdf_y = ksmooth_result[[1]]$y
  ) %>%
  ungroup() %>%
  select(-ksmooth_result)
  
```


## Visualize observations (all)
```{r}
#| fig-width: 8
#| fig-height: 6

plot_prev = ggplot(obs_stats_all, aes(y = bd_prevalence, x = taxon_capture)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = bd_prevalence_ci_lower, ymax = bd_prevalence_ci_upper),
                width = 0.2,
                position = position_dodge(width = 0.5)) +
  theme_minimal() +
  ggtitle("Observed prevalence") +
  xlab("Species") +
  ylab("Bd prevalence [-]\n(with 95% CI)") +
  geom_text(aes(label = paste0("n=", n), y = 1),
          position = position_dodge(width = 0.5)) +
  ylim(0, 1) +
  theme(legend.position = "none") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_prev_obs.png"),
       plot = plot_prev,
       height = 6,
       width = 8)

plot_prev

plot_load = ggplot(bd_model %>%
         mutate(taxon_capture = get_species_name(taxon_capture)) %>%
         filter(bd_load > 0), aes(log_bd_load, x = taxon_capture)) +
  geom_boxplot() + 
  theme_minimal() +
  ggtitle("Observed Bd-positive load") +
  xlab("Species") +
  ylab("log(Bd load) [-]") +
  geom_text(
    data = obs_stats_all,
    aes(
      x = taxon_capture,
      y = max(bd_model$log_bd_load) * 1.05,
      label = paste0("n=", n_pos)
    ),
    position = position_dodge(width = 0.75),
    vjust = 0
  ) +
  ylim(log(0.3), 20) +
  theme(legend.position = "none") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


ggsave(filename = here("pa_resilience_paper_files", "pa_bd_load_obs.png"),
       plot = plot_load,
       height = 6,
       width = 8)

plot_load

plot_ccdf = ggplot(ccdf_extended_all, aes(x = ccdf_x,
                          y = ccdf_y,
                          color = taxon_capture)) +
  geom_line() +
  theme_minimal() +
  ggtitle("Modeled CCDF of Bd-positive load") +
  labs(color = "Species",
       fill = "Species") +
  xlab("log(Bd load) [-]") +
  ylab("Complementary cumulative density (1 - CDF) [-]") +
  scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0)) +
  ylim(0, 1) +
  theme_minimal()

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_ccdf_smooth_obs.png"),
       plot = plot_ccdf,
       height = 6,
       width = 8)

plot_ccdf

```

## Visualize observations (aadult only)
```{r}
#| fig-width: 8
#| fig-height: 6

plot_prev = ggplot(obs_stats_adult, aes(y = bd_prevalence, x = taxon_capture)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = bd_prevalence_ci_lower, ymax = bd_prevalence_ci_upper),
                width = 0.2,
                position = position_dodge(width = 0.5)) +
  theme_minimal() +
  ggtitle("Observed prevalence") +
  xlab("Species") +
  ylab("Bd prevalence [-]\n(with 95% CI)") +
  geom_text(aes(label = paste0("n=", n), y = 1),
          position = position_dodge(width = 0.5)) +
  ylim(0, 1) +
  theme(legend.position = "none") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_prev_obs_adult.png"),
       plot = plot_prev,
       height = 6,
       width = 8)

plot_prev

plot_load = ggplot(bd_model %>%
         mutate(taxon_capture = get_species_name(taxon_capture)) %>%
         filter(life_stage_simple == "adult",
                bd_load > 0), aes(log_bd_load, x = taxon_capture)) +
  geom_boxplot() + 
  theme_minimal() +
  ggtitle("Observed Bd-positive load") +
  xlab("Species") +
  ylab("log(Bd load) [-]") +
  geom_text(
    data = obs_stats_all,
    aes(
      x = taxon_capture,
      y = max(bd_model$log_bd_load) * 1.05,
      label = paste0("n=", n_pos)
    ),
    position = position_dodge(width = 0.75),
    vjust = 0
  ) +
  ylim(log(0.3), 20) +
  theme(legend.position = "none") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


ggsave(filename = here("pa_resilience_paper_files", "pa_bd_load_obs_adult.png"),
       plot = plot_load,
       height = 6,
       width = 8)

plot_load

plot_ccdf = ggplot(ccdf_extended_all, aes(x = ccdf_x,
                          y = ccdf_y,
                          color = taxon_capture)) +
  geom_line() +
  theme_minimal() +
  ggtitle("Modeled CCDF of Bd-positive load") +
  labs(color = "Species",
       fill = "Species") +
  xlab("log(Bd load) [-]") +
  ylab("Complementary cumulative density (1 - CDF) [-]") +
  scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0)) +
  ylim(0, 1) +
  theme_minimal()

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_ccdf_smooth_obs_adult.png"),
       plot = plot_ccdf,
       height = 6,
       width = 8)

plot_ccdf

```

# Modeling
## Bd prevalence
```{r}
#| fig-height: 6
#| fig-width: 8

brm_prev = brm(
  formula = bd_detected ~ taxon_capture,
  family  = bernoulli(link = "logit"),
  data    = bd_model,
  chains  = 4, cores = 4, iter = 4000,
  seed    = 42
)

summary(brm_prev)

brm_prev_null = brm(
  bd_detected ~ 1,
  family = bernoulli(),
  data = bd_model
)

bf_prev = bayes_factor(brm_prev, brm_prev_null)

dput(get_variables(brm_prev))

prev_draws = brm_prev %>%
  spread_draws(
    b_Intercept,
    b_taxon_capturecolostethus_panamansis,
    b_taxon_capturecraugastor_crassidigitus, 
    b_taxon_capturecraugastor_fitzingeri,
    b_taxon_capturedendrobates_auratus, 
    b_taxon_captureespadarana_prosoblepon,
    b_taxon_capturelithobates_warszewitschii, 
    b_taxon_capturepristimantis_ridens,
    b_taxon_capturerhaebo_haematiticus, 
    b_taxon_capturerhinella_marina,
    b_taxon_capturesachatamia_albomaculata, 
    b_taxon_capturesilverstoneia_flotator,
    b_taxon_capturesilverstoneia_nubicola, 
    b_taxon_capturesmilisca_sila) %>%
  mutate(b_taxon_captureatelopus_varius = 0) %>%
  pivot_longer(c("b_taxon_captureatelopus_varius",
                 "b_taxon_capturecolostethus_panamansis",
                 "b_taxon_capturecraugastor_crassidigitus", 
                 "b_taxon_capturecraugastor_fitzingeri",
                 "b_taxon_capturedendrobates_auratus", 
                 "b_taxon_captureespadarana_prosoblepon",
                 "b_taxon_capturelithobates_warszewitschii", 
                 "b_taxon_capturepristimantis_ridens",
                 "b_taxon_capturerhaebo_haematiticus", 
                 "b_taxon_capturerhinella_marina",
                 "b_taxon_capturesachatamia_albomaculata", 
                 "b_taxon_capturesilverstoneia_flotator",
                 "b_taxon_capturesilverstoneia_nubicola", 
                 "b_taxon_capturesmilisca_sila"),
               names_to = "param",
               values_to = "taxon_intercept") %>%
  mutate(full_intercept = b_Intercept + taxon_intercept,
         bd_prevalence = plogis(full_intercept),
         taxon_capture = gsub("b_taxon_capture", "", param))

emm_prev = emmeans(brm_prev, ~ taxon_capture, type = "response")
emm_prev

pairwise_comparison_prev = pairs(emm_prev, adjust = "tukey")
pairwise_comparison_prev

emm_prev_df = as.data.frame(emm_prev)

# Region of practical equivalence
f_rope = function(draws, col, taxon_a, taxon_b, epsilon, factor=1) {
  
  p_a = draws %>%
    filter(taxon_capture == taxon_a) %>%
    pull(.data[[col]]) %>%
    rep(times = factor) %>%
    sample()
  
  p_b = draws %>%
    filter(taxon_capture == taxon_b) %>%
    pull(.data[[col]]) %>%
    rep(times = factor) %>%
    sample()
    
    rope = mean(abs(p_a - p_b) < epsilon)
    
    return(rope)
}


taxon_list_prev = emm_prev_df %>%
  arrange(desc(response)) %>%
  select(taxon_capture) %>%
  distinct() %>%
  pull(taxon_capture) %>%
  as.character()

prev_rope_df =  as.data.frame(t(combn(taxon_list_prev, 2))) %>%
  rename(taxon_a = V1,
         taxon_b = V2) %>%
  # cross_join(taxon_list, taxon_list) %>%  # all pairs
  # rename(taxon_a = taxon_capture.x,
  #        taxon_b = taxon_capture.y) %>%
  mutate(rope_05 = map2_dbl(taxon_a,
                            taxon_b,
                            ~ f_rope(prev_draws, "bd_prevalence", .x, .y, epsilon = 0.05, factor = 5)),
         rope_05_05 = rope_05 < 0.05,
         sig_txt = case_when(
           rope_05 < 0.001 ~ "***",
           rope_05 < 0.01 ~ "**",
           rope_05 < 0.05 ~ "*",
           .default = NA
         ),
         taxon_a = factor(taxon_a, levels = taxon_list_prev),
         taxon_b = factor(taxon_b, levels = taxon_list_prev)
  )
  

# visualization

# draws
plot_prev_draws = ggplot(prev_draws, aes(x = taxon_capture, y = bd_prevalence)) +
  geom_boxplot() +
  labs(y = "Estimated prevalence (model draws)",
       x = "Taxon",
       title = "Posterior prevalence per taxon (modeled)") +
  ylim(0, 1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_prev_draws.png"),
       plot = plot_prev_draws,
       height = 6,
       width = 8)

plot_prev_draws

# emmeans
plot_prev_emm = ggplot(emm_prev_df, aes(x = taxon_capture, y = response, ymin = lower.HPD, ymax = upper.HPD)) +
  geom_pointrange() +
  labs(y = "Estimated prevalence (posterior mean)",
       x = "Taxon",
       title = "Posterior prevalence per taxon (modeled)") +
  ylim(0,1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_prev_emm.png"),
       plot = plot_prev_emm,
       height = 6,
       width = 8)

plot_prev_emm

# rope
plot_prev_rope_05 = ggplot(prev_rope_df, aes(x = taxon_a, y = taxon_b, fill = rope_05)) +
  geom_tile(color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  geom_text(aes(label = sig_txt), color = "white", size = 4)

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_prev_rope_05.png"),
       plot = plot_prev_rope_05,
       height = 6,
       width = 8)

plot_prev_rope_05

```

## Bd load
```{r}
#| fig-height: 6
#| fig-width: 8

#baysian model
brm_load = brm(
  formula = log_bd_positive_load ~ taxon_capture,
  family = gaussian(),
  data = bd_model,
  chains = 4, cores = 4,
  iter = 4000,
  seed = 42
)

summary(brm_load)

brm_load_null = brm(
  log_bd_positive_load ~ 1,
  family = gaussian(),
  data = bd_model
)

bf_load = bayes_factor(brm_load, brm_load_null)

dput(get_variables(brm_load))

load_draws = brm_load %>%
  spread_draws(
    b_Intercept,
    b_taxon_capturecolostethus_panamansis,
    b_taxon_capturecraugastor_crassidigitus, 
    b_taxon_capturecraugastor_fitzingeri,
    b_taxon_capturedendrobates_auratus, 
    b_taxon_captureespadarana_prosoblepon,
    b_taxon_capturelithobates_warszewitschii, 
    b_taxon_capturepristimantis_ridens,
    b_taxon_capturerhaebo_haematiticus, 
    b_taxon_capturerhinella_marina,
    b_taxon_capturesachatamia_albomaculata, 
    b_taxon_capturesilverstoneia_flotator,
    b_taxon_capturesilverstoneia_nubicola, 
    b_taxon_capturesmilisca_sila) %>%
  mutate(b_taxon_captureatelopus_varius = 0) %>%
  pivot_longer(c("b_taxon_captureatelopus_varius",
                 "b_taxon_capturecolostethus_panamansis",
                 "b_taxon_capturecraugastor_crassidigitus", 
                 "b_taxon_capturecraugastor_fitzingeri",
                 "b_taxon_capturedendrobates_auratus", 
                 "b_taxon_captureespadarana_prosoblepon",
                 "b_taxon_capturelithobates_warszewitschii", 
                 "b_taxon_capturepristimantis_ridens",
                 "b_taxon_capturerhaebo_haematiticus", 
                 "b_taxon_capturerhinella_marina",
                 "b_taxon_capturesachatamia_albomaculata", 
                 "b_taxon_capturesilverstoneia_flotator",
                 "b_taxon_capturesilverstoneia_nubicola", 
                 "b_taxon_capturesmilisca_sila"),
               names_to = "param",
               values_to = "taxon_intercept") %>%
  mutate(bd_log_load = b_Intercept + taxon_intercept,
         taxon_capture = gsub("b_taxon_capture", "", param))

# emmeans
emm_load = emmeans(brm_load, ~ taxon_capture, type = "response")
emm_load

pairwise_comparison_load = pairs(emm_load, adjust = "tukey")
pairwise_comparison_load

emm_load_df = as.data.frame(emm_load)

# Region of practical equivalence

taxon_list_load = emm_load_df %>%
  arrange(desc(emmean)) %>%
  select(taxon_capture) %>%
  distinct() %>%
  pull(taxon_capture) %>%
  as.character()

load_rope_df = as.data.frame(t(combn(taxon_list_load, 2))) %>%
  rename(taxon_a = V1,
         taxon_b = V2) %>%
  # cross_join(taxon_list, taxon_list) %>%  # all pairs
  # rename(taxon_a = taxon_capture.x,
  #        taxon_b = taxon_capture.y) %>%
  mutate(rope_1 = map2_dbl(taxon_a,
                            taxon_b,
                            ~ f_rope(load_draws, "bd_log_load", .x, .y, epsilon = 1, factor = 5)),
         rope_1_05 = rope_1 < 0.05,
         sig_txt = case_when(
           rope_1 < 0.001 ~ "***",
           rope_1 < 0.01 ~ "**",
           rope_1 < 0.05 ~ "*",
           .default = NA
         ),
         taxon_a = factor(taxon_a, levels = taxon_list_load),
         taxon_b = factor(taxon_b, levels = taxon_list_load)
  )


# visualization

# draws
plot_load_draws = ggplot(load_draws, aes(x = taxon_capture, y = bd_log_load)) +
  geom_boxplot() +
  labs(y = "Estimated log(Bd load) (model draws)",
       x = "Taxon",
       title = "Posterior Bd-positive load per taxon (modeled)") +
  theme_minimal () +
  ylim(0, 15) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_load_draws.png"),
       plot = plot_load_draws,
       height = 6,
       width = 8)

plot_load_draws

# emmeans
plot_load_emm = ggplot(emm_load_df, aes(x = taxon_capture, y = emmean, ymin = lower.HPD, ymax = upper.HPD)) +
  geom_pointrange() +
  labs(y = "Estimated log(Bd load) (posterior mean)",
       x = "Taxon",
       title = "Posterior Bd-positive load per taxon (modeled)") +
  theme_minimal() +
  ylim(0, 15) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_load_emm.png"),
       plot = plot_load_emm,
       height = 6,
       width = 8)

plot_load_emm

# rope
plot_load_rope_1 = ggplot(load_rope_df, aes(x = taxon_a, y = taxon_b, fill = rope_1)) +
  geom_tile(color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  geom_text(aes(label = sig_txt), color = "white", size = 4)

ggsave(filename = here("pa_resilience_paper_files", "pa_bd_load_rope_1.png"),
       plot = plot_load_rope_1,
       height = 6,
       width = 8)

plot_load_rope_1
# 
# # frequentist tests
# # anova for bd log loads
# load_model = aov(log_bd_positive_load ~ taxon_capture,
#                    data = bd_model)
# 
# summary(load_model)
# 
# load_tuk = TukeyHSD(load_model)
# load_tuk
# 
# plot(load_tuk, las = 2)
# 
# tuk_df = as.data.frame(load_tuk$taxon_capture)
# tuk_df$comparison = rownames(tuk_df)
# 
# tuk_a = tuk_df %>%
#   rename(p_adj = `p adj`) %>%
#   separate(col = comparison, into = c("taxon_a", "taxon_b"), sep = "-") %>%
#   mutate(diff_abs = abs(diff),
#          significant = p_adj < 0.05,
#          p_adj_txt = if_else(significant, as.character(round(p_adj, digits = 4)), NA),
#          p_adj_txt = if_else(p_adj < 0.001, "<0.001", p_adj_txt),
#          sig_txt = case_when(
#            p_adj < 0.001 ~ "***",
#            p_adj < 0.01 ~ "**",
#            p_adj < 0.05 ~ "*",
#            .default = NA
#          ))
#   
# ggplot(tuk_a, aes(taxon_a, taxon_b, fill=significant)) + 
#   geom_tile(color = "#000") +
#   theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
#   geom_text(aes(label = p_adj_txt), color = "black", size = 2)
# 
# ggplot(tuk_a, aes(taxon_a, taxon_b, fill=p_adj)) + 
#   geom_tile(color = "#000") +
#   theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
#   geom_text(aes(label = sig_txt), color = "white", size = 4)
# 

```



```{r}


```