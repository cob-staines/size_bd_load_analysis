---
title: "Size vs. Bd modeling: Panamá preliminary results"
author: Cob Staines
date: 2025-09-29
format:
  html:
    toc: true
df-print: kable
bibliography: references.bib
csl: ecology.csl
---
# Introduction

## Motivation

Patterns of greater Bd load in recently metamorphosed individuals have been documented in some cases[@adams_chytridiomycosis-induced_2020] [@humphries_immune_2022] [@humphries_chytridiomycosis_2024] [@humphries_chytridiomycosis_2025] (and the opposite pattern in others[@bradley_host_2019]), with possible implications for:

  - resilience trajectory assessment (Q1)
  - population dynamics (Q2)
  - assessing Bd resistance/tolerance mechanisms (Q3)
  
... with the goal of complementing ongoing RIBBiTR research efforts

## Working hypotheses:

  a. Recently-metamorphosed individuals are more likely to be infected with Bd than older individuals across species
  b. Recently-metamorphosed individuals are more likely to carry higher Bd loads than older individuals across species

# Methods
## Setup

```{r}
#| eval: true
#| output: false
#| code-fold: true
#| code-summary: "Show setup code"

# setup
librarian::shelf(tidyverse, dbplyr, here, janitor, RPostgres, DBI, RIBBiTR-BII/ribbitrrr, brms, tidybayes, ggplot2, ggrepel, bayesplot, runner, cmdstanr, bayestestR)

```
## Data selection
### Classifying by life stage
These analyses were carried out for post-metamorphic individuals only. Individuals were classified as "adult" or "subadult" with a threshold snout-vent-length (SVL [mm]), identified independently for each species from the literature (see data collection code for specific thresholds used and their sources).
  
### Classification by population
"Populations" were defined at the region level within Panamá. In the Sierra Nevada, sites were grouped where evidence supported connectivity at he scale of individuals. Elsewhere in North America, populations were defined at the site level.

### Species selection criteria:
Species were included if supported by least 14 swabbed adults and subadults (each), with at least 5 Bd-positive adults and subadults (each).

### Bd density and Zero-cutoff
I scaled all Bd quantities by the Snout-Vent-Length (mm) to arrive at a Bd density per distance of skin swabbed, to correct for linear effects of larger swabbing area in larger frogs. I also set any Bd ITS copy numbers < (or 1/10 zoospore equivalent) equal to zero to represent uncertainty in qPCR results, and support sonsistency in zero-inflation modeling.


```{r}
#| eval: false
#| warning: false
#| code-fold: true
#| code-summary: "Show data collection code"

## Connect to DB
dbcon = hopToDB("ribbitr", hopReg = FALSE)

# table pointers
db_bd = tbl(dbcon, Id("survey_data", "bd_qpcr_results"))
db_sample = tbl(dbcon, Id("survey_data", "sample"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_visit = tbl(dbcon, Id("survey_data", "visit"))
db_site = tbl(dbcon, Id("survey_data", "site"))
db_region = tbl(dbcon, Id("survey_data", "region"))
db_country = tbl(dbcon, Id("survey_data", "country"))

# preliminary data
bd_sample = db_sample %>%
  right_join(db_capture, by = "capture_id") %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by = "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  filter(sample_type == "bd") %>%
  inner_join(db_bd %>%
              filter(!is.na(bd_detected)) %>%
               # limit to one qPCR result per sample
              group_by(sample_id) %>%
              slice_sample(n = 1) %>%
              ungroup() %>%
              select(sample_id,
                     bd_detected,
                     bd_its1_copies_per_swab), by = "sample_id")

# csv data
## SN populations
sn_populations = read.csv(here("data", "sn_site_pop_2_2025-10-31.csv")) %>%
  rename(population = pop_id) %>%
  mutate(population_sn = if_else(!is.na(population), paste0(as.character(population), "_pop"), site),
         site = as.character(site)) %>%
  select(site,
         population_sn)


population_valid_pa = c("altos_de_campana",
                        "caribbean",
                        "el_cope",
                        "el_valle",
                        "santa_fe")

# define populations
bd_population = bd_sample %>%
  left_join(sn_populations, by = "site", copy = TRUE) %>%
  mutate(population = case_when(
    country %in% c("brazil", "panama") ~ region,
    region == "california" ~ population_sn,
    .default = site
  )) %>%
  filter(country != "panama" | (country == "panama" & population %in% population_valid_pa))

bd_stats = bd_population %>%
  filter(!is.na(taxon_capture),
         life_stage %in% c("adult",
                           "subadult",
                           "juvenile",
                           NA)) %>%
  group_by(country,
           taxon_capture,
           life_stage) %>%
  summarize(n = n(),
            regions = str_flatten(distinct(region), collapse = ", "),
            .groups = "drop") %>%
  collect() %>%
  arrange(country,
          taxon_capture,
          life_stage)

# define life stage simple
bd_life_stage = bd_population %>%
  filter(life_stage %in% c("adult",
                           "subadult",
                           "juvenile",
                           NA)) %>%
  mutate(life_stage_simple = case_when(
    # us
    # https://animaldiversity.org/accounts/Acris_blanchardi/
    ((taxon_capture == "acris_blanchardi") & (svl_mm >= 16)) ~ "adult",
    ((taxon_capture == "acris_blanchardi") & (svl_mm < 16)) ~ "subadult",
    # Wright and Wright 1949
    ((taxon_capture == "anaxyrus_americanus") & (svl_mm >= 54)) ~ "adult",
    ((taxon_capture == "anaxyrus_americanus") & (svl_mm < 54)) ~ "subadult",
    # Lannoo 2005 (Amphibian Declines: The Conservation Status of United States Species)
    ((taxon_capture == "anaxyrus_canorus") & (svl_mm >= 48)) ~ "adult",
    ((taxon_capture == "anaxyrus_canorus") & (svl_mm < 48)) ~ "subadult",
    # Lannoo 2005
    ((taxon_capture == "anaxyrus_debilis") & (svl_mm >= 37)) ~ "adult",
    ((taxon_capture == "anaxyrus_debilis") & (svl_mm < 37)) ~ "subadult",
    # Conant and Collins 1991
    ((taxon_capture == "anaxyrus_fowleri") & (svl_mm >= 51)) ~ "adult",
    ((taxon_capture == "anaxyrus_fowleri") & (svl_mm < 51)) ~ "subadult",
    # Lannoo 2005
    ((taxon_capture == "hyla_chrysoscelis") & (svl_mm >= 32)) ~ "adult",
    ((taxon_capture == "hyla_chrysoscelis") & (svl_mm < 32)) ~ "subadult",
    # Conant & Collins 1998
    ((taxon_capture == "hyla_cinerea") & (svl_mm >= 32)) ~ "adult",
    ((taxon_capture == "hyla_cinerea") & (svl_mm < 32)) ~ "subadult",
    # Johnson 1987
    ((taxon_capture == "hyla_versicolor") & (svl_mm >= 32)) ~ "adult",
    ((taxon_capture == "hyla_versicolor") & (svl_mm < 32)) ~ "subadult",
    # Minton, 2001 / Lanoo 2005
    ((taxon_capture == "lithobates_blairi") & (svl_mm >= 51)) ~ "adult",
    ((taxon_capture == "lithobates_blairi") & (svl_mm < 51)) ~ "subadult",
    # Platz and Mecham 1963
    ((taxon_capture == "lithobates_chiricahuensis") & (svl_mm >= 57)) ~ "adult",
    ((taxon_capture == "lithobates_chiricahuensis") & (svl_mm < 57)) ~ "subadult",
    # Minton 2001
    ((taxon_capture == "lithobates_palustris") & (svl_mm >= 43)) ~ "adult",
    ((taxon_capture == "lithobates_palustris") & (svl_mm < 43)) ~ "subadult",
    # Conant and Collins, 1991
    ((taxon_capture == "lithobates_sphenocephalus") & (svl_mm >= 51)) ~ "adult",
    ((taxon_capture == "lithobates_sphenocephalus") & (svl_mm < 51)) ~ "subadult",
    # Lannoo 2005
    ((taxon_capture == "pseudacris_crucifer") & (svl_mm >= 20)) ~ "adult",
    ((taxon_capture == "pseudacris_crucifer") & (svl_mm < 20)) ~ "subadult",
    # Hulse, C. and McCoy C. J. and Ellen Censky ,1998.
    ((taxon_capture == "pseudacris_feriarum") & (svl_mm >= 19)) ~ "adult",
    ((taxon_capture == "pseudacris_feriarum") & (svl_mm < 19)) ~ "subadult",
    # Lannoo 2005
    ((taxon_capture == "pseudacris_regilla") & (svl_mm >= 25)) ~ "adult",
    ((taxon_capture == "pseudacris_regilla") & (svl_mm < 25)) ~ "subadult",
    # Howard 1981
    ((taxon_capture == "rana_catesbeiana") & (svl_mm >= 95)) ~ "adult",
    ((taxon_capture == "rana_catesbeiana") & (svl_mm < 95)) ~ "subadult",
    # Lannoo 2005
    ((taxon_capture == "rana_clamitans") & (svl_mm >= 60)) ~ "adult",
    ((taxon_capture == "rana_clamitans") & (svl_mm < 60)) ~ "subadult",
    # Knapp
    ((taxon_capture == "rana_muscosa") & (svl_mm >= 40)) ~ "adult",
    ((taxon_capture == "rana_muscosa") & (svl_mm < 40)) ~ "subadult",
    # https://www.nrc.gov/docs/ML1428/ML14282A848.pdf
    ((taxon_capture == "rana_pipiens") & (svl_mm >= 51)) ~ "adult",
    ((taxon_capture == "rana_pipiens") & (svl_mm < 51)) ~ "subadult",
    # Knapp
    ((taxon_capture == "rana_sierrae") & (svl_mm >= 40)) ~ "adult",
    ((taxon_capture == "rana_sierrae") & (svl_mm < 40)) ~ "subadult",
    # Martof 1963
    ((taxon_capture == "rana_sylvatica") & (svl_mm >= 37)) ~ "adult",
    ((taxon_capture == "rana_sylvatica") & (svl_mm < 37)) ~ "subadult",
    # Conant and Collins, 1991
    ((taxon_capture == "scaphiopus_holbrookii") & (svl_mm >= 44)) ~ "adult",
    ((taxon_capture == "scaphiopus_holbrookii") & (svl_mm < 44)) ~ "subadult",
    # Stebbins, 1985
    ((taxon_capture == "spea_multiplicata") & (svl_mm >= 37)) ~ "adult",
    ((taxon_capture == "spea_multiplicata") & (svl_mm < 37)) ~ "subadult",
    
    # brasil
    # Heyer, W. R., and R. B. Cocroft. 1986
    ((taxon_capture == "hylodes_phyllodes") & (svl_mm >= 27.5)) ~ "adult",
    ((taxon_capture == "hylodes_phyllodes") & (svl_mm < 27.5)) ~ "subadult",
    # Kwet, A., and M. Solé. 2005
    ((taxon_capture == "ischnocnema_henselii") & (svl_mm >= 21.0)) ~ "adult",
    ((taxon_capture == "ischnocnema_henselii") & (svl_mm < 21.0)) ~ "subadult",
    country == "brazil" & life_stage == "adult" ~ "adult",
    country == "brazil" & life_stage %in% c("subadult", "juvenile") ~ "subadult",
    
    # panama
    # Savage 1972 & Crump 1988
    ((taxon_capture == "atelopus_varius") & (svl_mm >= 25)) ~ "adult",
    ((taxon_capture == "atelopus_varius") & (svl_mm < 25)) ~ "subadult",
    # Lynch and Myers 1983
    ((taxon_capture == "craugastor_crassidigitus") & (svl_mm >= 20.2)) ~ "adult",
    ((taxon_capture == "craugastor_crassidigitus") & (svl_mm < 20.2)) ~ "subadult",
    # Lynch and Myers 1983
    ((taxon_capture == "craugastor_fitzingeri") & (svl_mm >= 23.5)) ~ "adult",
    ((taxon_capture == "craugastor_fitzingeri") & (svl_mm < 23.5)) ~ "subadult",
    # Amphibiaweb
    ((taxon_capture == "colostethus_panamansis") & (svl_mm >= 18.8)) ~ "adult",
    ((taxon_capture == "colostethus_panamansis") & (svl_mm < 18.8)) ~ "subadult",
    # Leenders 2001
    ((taxon_capture == "dendrobates_auratus") & (svl_mm >= 25)) ~ "adult",
    ((taxon_capture == "dendrobates_auratus") & (svl_mm < 25)) ~ "subadult",
    # Amphibiaweb
    ((taxon_capture == "espadarana_prosoblepon") & (svl_mm >= 21)) ~ "adult",
    ((taxon_capture == "espadarana_prosoblepon") & (svl_mm < 21)) ~ "subadult",
    # Basante 2025
    ((taxon_capture == "lithobates_warszewitschii") & (svl_mm >= 35)) ~ "adult",
    ((taxon_capture == "lithobates_warszewitschii") & (svl_mm < 35)) ~ "subadult",
    # Wang 2008
    ((taxon_capture == "pristimantis_ridens") & (svl_mm >= 16)) ~ "adult",
    ((taxon_capture == "pristimantis_ridens") & (svl_mm < 16)) ~ "subadult",
    # Savage 2002
    ((taxon_capture == "rhaebo_haematiticus") & (svl_mm >= 42)) ~ "adult",
    ((taxon_capture == "rhaebo_haematiticus") & (svl_mm < 42)) ~ "subadult",
    # Easteal 1963
    ((taxon_capture == "rhinella_marina") & (svl_mm >= 85)) ~ "adult",
    ((taxon_capture == "rhinella_marina") & (svl_mm < 85)) ~ "subadult",
    # Savage 2002
    ((taxon_capture == "sachatamia_albomaculata") & (svl_mm >= 20.5)) ~ "adult",
    ((taxon_capture == "sachatamia_albomaculata") & (svl_mm < 20.5)) ~ "subadult",
    # Ibunez & Smith 1995
    ((taxon_capture == "silverstoneia_flotator") & (svl_mm >= 15.1)) ~ "adult",
    ((taxon_capture == "silverstoneia_flotator") & (svl_mm < 15.1)) ~ "subadult",
    # Grant & Myers 2013
    ((taxon_capture == "silverstoneia_nubicola") & (svl_mm >= 15.4)) ~ "adult",
    ((taxon_capture == "silverstoneia_nubicola") & (svl_mm < 15.4)) ~ "subadult",
    # Duellman, W. E. 2001
    ((taxon_capture == "smilisca_sila") & (svl_mm >= 31.6)) ~ "adult",
    ((taxon_capture == "smilisca_sila") & (svl_mm < 31.6)) ~ "subadult",
    .default = NA_character_
  )) %>%
  filter(!is.na(life_stage_simple))

# identify valid species & populations
## drop pops without both adults and juveniles
## drop species without 14 or more adults and juveniles each
pop_valid = bd_life_stage %>%
  group_by(taxon_capture, population) %>%
  mutate(pop_adult_present = any(life_stage_simple == "adult"),
         pop_subadult_present = any(life_stage_simple == "subadult")) %>%
  ungroup() %>%
  filter(pop_adult_present & pop_subadult_present)

species_valid = pop_valid %>%
  group_by(taxon_capture, life_stage_simple) %>%
  summarise(count = n(),
            count_gt_14 = n() >= 14,
            .groups = "drop") %>%
  group_by(taxon_capture) %>%
  filter(sum(as.integer(count_gt_14)) == 2) %>%
  ungroup() %>%
  select(taxon_capture) %>%
  distinct()

pop_species_valid = pop_valid %>%
  inner_join(species_valid, by = "taxon_capture") %>%
  select(taxon_capture,
         population) %>%
  distinct()

# identify valid samples
bd_sample_valid = bd_life_stage %>%
  mutate(year = year(date),
         month = month(date)) %>%
  inner_join(pop_species_valid, by = c("taxon_capture", "population")) %>%
  # limit to 1 bd sample per capture
  group_by(capture_id) %>%
  slice_sample(n = 1) %>%
  ungroup() %>%
  select(sample_id,
         bd_detected,
         bd_its1_copies_per_swab,
         sample_name,
         capture_id,
         taxon_capture,
         life_stage,
         life_stage_simple,
         svl_mm,
         body_mass_g,
         sex,
         date,
         month,
         year,
         site,
         site_id,
         population,
         region,
         country) %>%
  collect()

# final data selection and cleaning for model
bd_model = bd_sample_valid %>%
  rename(bd_load = bd_its1_copies_per_swab) %>%
  mutate(bd_detected_co = bd_load >= 6,
         bd_load_co = if_else(bd_load < 6,
                                  0,
                                  bd_load),
         bd_load_co_density = bd_load_co / svl_mm,
         log_bd_load_co_density = log(bd_load_co_density),
         log_bd_load_co = log(bd_load_co)) %>%
  select(bd_detected_co,
         bd_load_co,
         log_bd_load_co,
         bd_load_co_density,
         log_bd_load_co_density,
         taxon_capture,
         life_stage,
         life_stage_simple,
         svl_mm,
         body_mass_g,
         sex,
         date,
         month,
         year,
         site,
         site_id,
         population,
         region,
         country)

head(bd_model)
```

## Environmental data
To support comparing Bd prevalence and loads between sites and species across a range of environmental conditions, I incorporated local daily daytime surface temperature (MODIS) and precipitation (CHIRPS) time series. Following Sonn et al. 2019 [sonn2019effects], I created 15-day and 30-day means (for tempurature) and sums (for precipitation). Preliminary model fitting showed stronger relationships between Bd prevalence and 15-day lag products, while Bd load showed stronger relationships with 30-day lag products, similar to Sonn et al. 2019.

### Spatio-temporal coverage
```{r}
#| eval: false
#| warning: false
#| code-fold: true
#| code-summary: "Code to export spatio-temporal coverage"

bd_model_stats = bd_model %>%
  group_by(taxon_capture, country) %>%
  summarise(regions = paste(sort(unique(region)), collapse = ", "),
            population_n = n_distinct(population),
            site_n = n_distinct(site),
            year_first = year(min(date)),
            year_last = year(max(date)),
            year_count = n_distinct(year(date)),
            adult_n = sum(life_stage_simple == "adult"),
            subadult_n = sum(life_stage_simple == "subadult"),
            .groups = "drop") %>%
  arrange(country,
          taxon_capture)

temporal_report = bd_model %>%
  group_by(year) %>%
  summarise(n_obs = n(),
            n_adult = sum(life_stage_simple == "adult"),
            n_subadult = sum(life_stage_simple == "adult"),
            n_taxa = n_distinct(taxon_capture),
            n_site = n_distinct(site),
            n_pop = n_distinct(population),
            n_country = n_distinct(country),
            .groups = "drop")


chunk_date_range <- function(start_date, end_date, max_years = 5) {
  start <- as.Date(start_date)
  end <- as.Date(end_date)
  chunks <- data.frame(start_date = as.Date(character()), end_date = as.Date(character()))
  
  current_start <- start
  while (current_start < end) {
    chunk_end <- pmin(end, floor_date(current_start, "year") %m+% years(max_years) - days(1))
    chunks <- bind_rows(chunks, data.frame(start_date = current_start, end_date = chunk_end))
    current_start <- chunk_end + days(1)
  }
  
  return(chunks)
}


# export site list and coords
spatial_buffer = 0.025  # decimal degrees
temporal_buffer = 60  # days
min_date = min(bd_model$date) - days(temporal_buffer)
max_date = max(bd_model$date)
year_chunk = 11

# all sites for full date range, chunked by year_chunk
all_sites = bd_model %>%
  select(site_id, population, region, country) %>%
  distinct()

date_chunks = chunk_date_range(min_date, max_date, max_years = year_chunk)

all_sites_dates = all_sites %>%
  cross_join(date_chunks) %>%
    left_join(db_site %>%
              collect(), by = "site_id") %>%
  select(site_id,
         site,
         site_latitude,
         site_longitude,
         site_elevation_m,
         population,
         region,
         country,
         start_date,
         end_date) %>%
  mutate(duration = as.numeric(end_date - start_date)/365.25,
         N = site_latitude + spatial_buffer,
         S = site_latitude - spatial_buffer,
         W = site_longitude - spatial_buffer,
         E = site_longitude + spatial_buffer) %>%
  arrange(country,
          site)

# write_csv(all_sites_dates, here("python", "gee_env_pull", "data", "site_coords_dates_all_025.csv"))

```

### Join with env. data
```{r}
#| eval: false
#| warning: false
#| code-fold: true
#| code-summary: "Show environmental data mergin code"
#| 
env_in = read_csv(here("python", "gee_env_pull", "data", "gee_chirps_modis_data_all.csv"))

sliding_window <- function(df, ts_col_name, window_size, f, result_col_name) {
  ts_sym <- sym(ts_col_name)
  res_sym <- sym(result_col_name)
  
  df %>%
    group_modify(~{
      n <- nrow(.x)
      ts_vals <- pull(.x, !!ts_sym)
      agg_vals <- map_dbl(seq_len(n), function(i) {
        if (i >= window_size) {
          window_vals <- ts_vals[(i - window_size + 1):i]
          f(window_vals)
        } else {
          NA_real_
        }
      })
      .x[[result_col_name]] <- agg_vals
      .x
    })
}

rolling_aggregate <- function(x, date, n_days, fun) {
  runner(
    x   = x,
    idx = date,
    k   = paste0(n_days, " days"),
    f   = fun
  )
}


n_val = function(x) sum(!is.na(x))

na_mean = function(x) {
  mean(x, na.rm = TRUE)
}

na_max = function(x) {
  max(x, na.rm = TRUE)
}

na_sum = function(x) {
  sum(x, na.rm = TRUE)
}

# env_agg = env_in %>%
#   arrange(site, date) %>%
#   filter(!(is.na(precipitation_mm) & is.na(temperature_c))) %>%
#   group_by(site) %>%
#   mutate(precip_mm_15_day_n = rolling_aggregate(precipitation_mm, date, 15, n_val),
#          precip_mm_15_day_sum = rolling_aggregate(precipitation_mm, date, 15, na_sum),
#          precip_mm_30_day_n = rolling_aggregate(precipitation_mm, date, 30, n_val),
#          precip_mm_30_day_sum = rolling_aggregate(precipitation_mm, date, 30, na_sum),
#          temp_c_15_day_n = rolling_aggregate(temperature_c, date, 15, n_val),
#          temp_c_15_day_mean = rolling_aggregate(temperature_c, date, 15, na_mean),
#          temp_c_15_day_max = rolling_aggregate(temperature_c, date, 15, na_max),
#          temp_c_30_day_n = rolling_aggregate(temperature_c, date, 30, n_val),
#          temp_c_30_day_mean = rolling_aggregate(temperature_c, date, 30, na_mean),
#          temp_c_30_day_max = rolling_aggregate(temperature_c, date, 30, na_max)) %>%
#   ungroup()
# 
# write_csv(env_agg, here("data", "unified_env_agg.csv"))
env_agg = read_csv(here("data", "unified_env_agg.csv"))

# site_climate = env_in %>%
#   group_by(site) %>%
#   summarize(site_temp_c_mean = mean(temperature_c, na.rm = TRUE),
#             p_temp = sum(!is.na(temperature_c)) / n(),
#             site_precip_mm_mean = mean(precipitation_mm, na.rm = TRUE),
#             p_precip = sum(!is.na(precipitation_mm)) / n(),
#             .groups = "drop") %>%
#   mutate(site_precip_mm_annual_mean = site_precip_mm_mean * 365.25)
# 
# write_csv(site_climate, here("data", "site_climate.csv"))
site_climate = read_csv(here("data", "site_climate.csv"))

# ggplot(env_agg, aes(x = date)) +
#   geom_line(aes(y = precip_mm_15_day_sum), linetype = "solid") +
#   facet_wrap(. ~ site)
# 
# ggplot(env_agg, aes(x = date, y = temp_c_year_mean, color = site)) +
#   geom_line()

# taxon_climate = env_agg %>%
#   left_join(bd_model %>%
#              select(taxon_capture, site) %>%
#              distinct(), by = "site") %>%
#   group_by(taxon_capture) %>%
#   summarize(precip_mm_15_day_sum_spmean = mean(precip_mm_15_day_sum),
#             precip_mm_15_day_sum_spsd = sd(precip_mm_15_day_sum),
#             precip_mm_30_day_sum_spmean = mean(precip_mm_30_day_sum),
#             precip_mm_30_day_sum_spsd = sd(precip_mm_30_day_sum),
#             temp_c_15_day_mean_spmean = mean(temp_c_15_day_mean, na.rm = TRUE),
#             temp_c_15_day_mean_spsd = sd(temp_c_15_day_mean, na.rm = TRUE),
#             temp_c_30_day_mean_spmean = mean(temp_c_30_day_mean, na.rm = TRUE),
#             temp_c_30_day_mean_spsd = sd(temp_c_30_day_mean, na.rm = TRUE),
#             precip_mm_15_day_sum2_spmean = mean(precip_mm_15_day_sum^2),
#             precip_mm_15_day_sum2_spsd = sd(precip_mm_15_day_sum^2),
#             precip_mm_30_day_sum2_spmean = mean(precip_mm_30_day_sum^2),
#             precip_mm_30_day_sum2_spsd = sd(precip_mm_30_day_sum^2),
#             temp_c_15_day_mean2_spmean = mean(temp_c_15_day_mean^2, na.rm = TRUE),
#             temp_c_15_day_mean2_spsd = sd(temp_c_15_day_mean^2, na.rm = TRUE),
#             temp_c_30_day_mean2_spmean = mean(temp_c_30_day_mean^2, na.rm = TRUE),
#             temp_c_30_day_mean2_spsd = sd(temp_c_30_day_mean^2, na.rm = TRUE))
# 
# write_csv(taxon_climate, here("data", "taxon_climate.csv"))

# bd_model_env = bd_model %>%
#   left_join(env_agg, by = c("site", "date")) %>%
#   left_join(site_climate, by = "site") %>%
#   filter(!is.na(precip_mm_15_day_sum),
#          !is.na(precip_mm_30_day_sum),
#          !is.na(temp_c_15_day_mean),
#          !is.na(temp_c_30_day_mean))
# 
# save(bd_model_env, file = here("data", paste0("bd_model_env_unified_", today(), ".RData")))

```

## Load saved data
```{r}
#| eval: true
#| warning: false
#| echo: false
#| code-fold: true
#| code-summary: "Show data loading code"

load(here("data", "bd_model_env_unified_2026-01-23.RData"))

taxon_climate = read_csv(here("data", "taxon_climate.csv"))

```

# Descriptive stats
```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Show descriptive stats code"

bd_model_env_stats = bd_model_env %>%
  group_by(taxon_capture, country) %>%
  summarise(regions = paste(sort(unique(region)), collapse = ", "),
            population_n = n_distinct(population),
            site_n = n_distinct(site),
            year_first = year(min(date)),
            year_last = year(max(date)),
            year_count = n_distinct(year(date)),
            adult_n = sum(life_stage_simple == "adult"),
            adult_n_pos = sum(life_stage_simple == "adult" & bd_detected_co),
            subadult_n = sum(life_stage_simple == "subadult"),
            subadult_n_pos = sum(life_stage_simple == "subadult" & bd_detected_co),
            .groups = "drop") %>%
  arrange(country,
          taxon_capture)

species_select = bd_model_env_stats %>%
  filter(adult_n_pos >= 5,
         subadult_n_pos >= 5)

bd_model_env_select = bd_model_env %>%
  filter(taxon_capture %in% species_select$taxon_capture) %>%
  filter(!is.na(bd_load_co_density))

(bd_model_env_select_stats = bd_model_env_stats %>%
  filter(adult_n_pos >= 5,
         subadult_n_pos >= 5))

```

# Modeling
I modeled Bd load using a Baysian zero-inflated (or "hurdle") log-normal model [@schrock2025fungi] with fixed effects of species, life stage, and recent precipitation and temperature, and considering population, species, life stage and recent precipitation and temperature as a random effects. The "hurdle" infection probability (hu) and the variability in Bd load (sigma) are allowed to vary with life stage.

## Model setup
```{r}
#| code-fold: true
#| code-summary: "Show model setup code"

# unified, scaled model
brms_scales = bd_model_env_select %>%
  group_by() %>%
  summarize(precip_mm_15_day_sum_mean = mean(precip_mm_15_day_sum),
            precip_mm_15_day_sum_sd = sd(precip_mm_15_day_sum),
            precip_mm_30_day_sum_mean = mean(precip_mm_30_day_sum),
            precip_mm_30_day_sum_sd = sd(precip_mm_30_day_sum),
            temp_c_15_day_mean_mean = mean(temp_c_15_day_mean),
            temp_c_15_day_mean_sd = sd(temp_c_15_day_mean),
            temp_c_30_day_mean_mean = mean(temp_c_30_day_mean),
            temp_c_30_day_mean_sd = sd(temp_c_30_day_mean),
            precip_mm_15_day_sum2_mean = mean(precip_mm_15_day_sum ^ 2),
            precip_mm_15_day_sum2_sd = sd(precip_mm_15_day_sum ^ 2),
            precip_mm_30_day_sum2_mean = mean(precip_mm_30_day_sum ^ 2),
            precip_mm_30_day_sum2_sd = sd(precip_mm_30_day_sum ^ 2),
            temp_c_15_day_mean2_mean = mean(temp_c_15_day_mean ^ 2),
            temp_c_15_day_mean2_sd = sd(temp_c_15_day_mean ^ 2),
            temp_c_30_day_mean2_mean = mean(temp_c_30_day_mean ^ 2),
            temp_c_30_day_mean2_sd = sd(temp_c_30_day_mean ^ 2),
            site_precip_mm_annual_mean_mean = mean(site_precip_mm_annual_mean),
            site_precip_mm_annual_mean_sd = sd(site_precip_mm_annual_mean),
            site_temp_c_mean_mean = mean(site_temp_c_mean),
            site_temp_c_mean_sd = sd(site_temp_c_mean))

brms_rescale = function(df, scales) {
  df_out = df %>%
    mutate(precip_mm_15_z = (precip_mm_15_day_sum - scales$precip_mm_15_day_sum_mean)/scales$precip_mm_15_day_sum_sd,
           precip_mm_30_z = (precip_mm_30_day_sum - scales$precip_mm_30_day_sum_mean)/scales$precip_mm_30_day_sum_sd,
           temp_c_15_z = (temp_c_15_day_mean - scales$temp_c_15_day_mean_mean)/scales$temp_c_15_day_mean_sd,
           temp_c_30_z = (temp_c_30_day_mean - scales$temp_c_30_day_mean_mean)/scales$temp_c_30_day_mean_sd,
           precip_mm_15_z2 = (precip_mm_15_day_sum^2 - scales$precip_mm_15_day_sum2_mean)/scales$precip_mm_15_day_sum2_sd,
           precip_mm_30_z2 = (precip_mm_30_day_sum^2 - scales$precip_mm_30_day_sum2_mean)/scales$precip_mm_30_day_sum2_sd,
           temp_c_15_z2 = (temp_c_15_day_mean^2 - scales$temp_c_15_day_mean2_mean)/scales$temp_c_15_day_mean2_sd,
           temp_c_30_z2 = (temp_c_30_day_mean^2 - scales$temp_c_30_day_mean2_mean)/scales$temp_c_30_day_mean2_sd
           )
}

brms_data <- bd_model_env_select %>%
  left_join(taxon_climate, by = "taxon_capture") %>%
  mutate(
    precip_mm_30_z = as.numeric(scale(precip_mm_30_day_sum, center = TRUE, scale = TRUE)),
    temp_c_30_z = as.numeric(scale(temp_c_30_day_mean, center = TRUE, scale = TRUE)),
    precip_mm_15_z = as.numeric(scale(precip_mm_15_day_sum, center = TRUE, scale = TRUE)),
    temp_c_15_z = as.numeric(scale(temp_c_15_day_mean, center = TRUE, scale = TRUE)),
    precip_mm_30_z2 = as.numeric(scale(precip_mm_30_day_sum ^ 2, center = TRUE, scale = TRUE)),
    temp_c_30_z2 = as.numeric(scale(temp_c_30_day_mean ^ 2, center = TRUE, scale = TRUE)),
    precip_mm_15_z2 = as.numeric(scale(precip_mm_15_day_sum ^ 2, center = TRUE, scale = TRUE)),
    temp_c_15_z2 = as.numeric(scale(temp_c_15_day_mean ^ 2, center = TRUE, scale = TRUE)),
    site_precip_mm_annual_mean_z = as.numeric(scale(site_precip_mm_annual_mean, center = TRUE, scale = TRUE)),
    site_temp_c_mean_z = as.numeric(scale(site_temp_c_mean, center = TRUE, scale = TRUE)),
    ##
    precip_mm_30_sp_z = (precip_mm_30_day_sum - precip_mm_30_day_sum_spmean) / precip_mm_30_day_sum_spsd,
    temp_c_30_sp_z = (temp_c_30_day_mean - temp_c_30_day_mean_spmean) / temp_c_30_day_mean_spsd,
    precip_mm_15_sp_z = (precip_mm_15_day_sum - precip_mm_15_day_sum_spmean) / precip_mm_15_day_sum_spsd,
    temp_c_15_sp_z = (temp_c_15_day_mean - temp_c_15_day_mean_spmean) / temp_c_15_day_mean_spsd,
    precip_mm_30_sp_z2 = (precip_mm_30_day_sum ^ 2 - precip_mm_30_day_sum2_spmean) / precip_mm_30_day_sum2_spsd,
    temp_c_30_sp_z2 = (temp_c_30_day_mean ^ 2 - temp_c_30_day_mean2_spmean) / temp_c_30_day_mean2_spsd,
    precip_mm_15_sp_z2 = (precip_mm_15_day_sum ^ 2 - precip_mm_15_day_sum2_spmean) / precip_mm_15_day_sum2_spsd,
    temp_c_15_sp_z2 = (temp_c_15_day_mean ^ 2 - temp_c_15_day_mean2_spmean) / temp_c_15_day_mean2_spsd
  ) %>%
  select(taxon_capture,
         -any_of(colnames(taxon_climate)),
         everything())

# check z-scored means and sds
peace = brms_data %>%
  summarize(t_15_mean = mean(temp_c_15_z),
            t_15_sd = sd(temp_c_15_z),
            t_30_mean = mean(temp_c_30_z),
            t_30_sd = sd(temp_c_30_z),
            p_15_mean = mean(precip_mm_15_z),
            p_15_sd = sd(precip_mm_15_z),
            p_30_mean = mean(precip_mm_30_z),
            p_30_sd = sd(precip_mm_30_z),
            t2_15_mean = mean(temp_c_15_z2),
            t2_15_sd = sd(temp_c_15_z2),
            t2_30_mean = mean(temp_c_30_z2),
            t2_30_sd = sd(temp_c_30_z2),
            p2_15_mean = mean(precip_mm_15_z2),
            p2_15_sd = sd(precip_mm_15_z2),
            p2_30_mean = mean(precip_mm_30_z2),
            p2_30_sd = sd(precip_mm_30_z2))

hope = brms_data %>%
  group_by(taxon_capture) %>%
  summarize(t_15_sp_mean = mean(temp_c_15_sp_z),
            t_15_sp_sd = sd(temp_c_15_sp_z),
            t_30_sp_mean = mean(temp_c_30_sp_z),
            t_30_sp_sd = sd(temp_c_30_sp_z),
            p_15_sp_mean = mean(precip_mm_15_sp_z),
            p_15_sp_sd = sd(precip_mm_15_sp_z),
            p_30_sp_mean = mean(precip_mm_30_sp_z),
            p_30_sp_sd = sd(precip_mm_30_sp_z),
            t2_15_sp_mean = mean(temp_c_15_sp_z2),
            t2_15_sp_sd = sd(temp_c_15_sp_z2),
            t2_30_sp_mean = mean(temp_c_30_sp_z2),
            t2_30_sp_sd = sd(temp_c_30_sp_z2),
            p2_15_sp_mean = mean(precip_mm_15_sp_z2),
            p2_15_sp_sd = sd(precip_mm_15_sp_z2),
            p2_30_sp_mean = mean(precip_mm_30_sp_z2),
            p2_30_sp_sd = sd(precip_mm_30_sp_z2))

model_priors <- c(
  # b
  prior(normal(0, 5), class = "Intercept"),
  prior(normal(0, 2),   class = "b"),
  
  # hu
  prior(normal(0, 2), class = "Intercept", dpar = "hu"),
  prior(normal(0, 1), class = "b", dpar = "hu"),
  
  # Sigma
  prior(normal(0, 1), class = "Intercept", dpar = "sigma"),
  prior(normal(0, 0.3), class = "b", dpar = "sigma"),
  
  # Random effects
  prior(exponential(1), class = "sd")
)

model_priors_ga <- c(
  # b
  prior(normal(0, 5), class = "Intercept"),
  prior(normal(0, 2),   class = "link"),
  
  # hu
  prior(normal(0, 2), class = "Intercept", dpar = "link_hu"),
  prior(normal(0, 1), class = "b", dpar = "link_hu"),
  
  # Sigma
  prior(normal(0, 1), class = "Intercept", dpar = "link_shape"),
  prior(normal(0, 0.3), class = "b", dpar = "link_shape"),
  
  # Random effects
  prior(exponential(1), class = "sd")
)

model_priors_fixed <- c(
  # b
  prior(normal(0, 5), class = "Intercept"),
  prior(normal(0, 2),   class = "b"),
  
  # hu
  prior(normal(0, 2), class = "Intercept", dpar = "hu"),
  prior(normal(0, 1), class = "b", dpar = "hu"),
  
  # Sigma
  prior(normal(0, 1), class = "Intercept", dpar = "sigma"),
  prior(normal(0, 0.3), class = "b", dpar = "sigma")
)

model_report = function(model_m){
  summary(model_m)
  plot((model_m), ask = FALSE)
  plot(conditional_effects(model_m), ask = FALSE)
  pp_check(model_m) +
    scale_x_log10()
}

set_cmdstan_path(Sys.getenv("cmd_stan_path"))
```

## Model fitting
```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Show model fitting code"

null_zln <- brm(
  bd_load_co_density ~ 1,
  data = brms_data,
  family = hurdle_lognormal(),
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

null_zln <- add_criterion(null_zln, "loo")

saveRDS(null_zln, file = here("unified_models/unified_model_results_zln_null.rds"))
null_zln = readRDS(file = here("unified_models/unified_model_results_zln_null.rds"))

nullb_zln <- brm(
  bd_load_co ~ 1,
  data = brms_data,
  family = hurdle_lognormal(),
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

nullb_zln <- add_criterion(nullb_zln, "loo")

saveRDS(nullb_zln, file = here("unified_models/unified_model_results_zln_nullb.rds"))
nullb_zln = readRDS(file = here("unified_models/unified_model_results_zln_nullb.rds"))

m1_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture,
    hu ~ 1 + life_stage_simple * taxon_capture,
    sigma ~ 1 + taxon_capture
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors_fixed,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m1_zln <- add_criterion(m1_zln, "loo")

saveRDS(m1_zln, file = here("unified_models/unified_model_results_zln_life_tax.rds"))
m1_zln = readRDS(file = here("unified_models/unified_model_results_zln_life_tax.rds"))


# m2_zln <- brm(
#   formula = bf(
#     bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 | population),
#     hu ~ 1 + life_stage_simple * taxon_capture + (1 | population),
#     sigma ~ 1 + taxon_capture
#   ),
#   data = brms_data,
#   family = hurdle_lognormal(),
#   prior = model_priors,
#   sample_prior = "yes",
#   control = list(adapt_delta = 0.95, max_treedepth = 12),
#   chains = 4,
#   iter = 2000,
#   warmup = 1000,
#   seed = 124,
#   cores = 4,
#   backend = "cmdstanr"
# )
# 
# m2_zln <- add_criterion(m2_zln, "loo")
# 
# saveRDS(m2_zln, file = here("unified_models/unified_model_results_zln_life_tax_pop.rds"))
# m2_zln = readRDS(file = here("unified_models/unified_model_results_zln_life_tax_pop.rds"))

m2b_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 | population),
    hu ~ 1 + life_stage_simple * taxon_capture + (1 | population),
    sigma ~ 1 + taxon_capture + (1 | population)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m2b_zln <- add_criterion(m2b_zln, "loo")

saveRDS(m2b_zln, file = here("unified_models/unified_model_results_zln_life_tax_popb.rds"))
m2b_zln = readRDS(file = here("unified_models/unified_model_results_zln_life_tax_popb.rds"))

# m2b_zga <- brm(
#   formula = bf(
#     bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 | population),
#     hu ~ 1 + life_stage_simple * taxon_capture + (1 | population),
#     shape ~ 1 + taxon_capture + (1 | population)
#   ),
#   data = brms_data,
#   family = hurdle_gamma(),
#   sample_prior = "yes",
#   control = list(adapt_delta = 0.95, max_treedepth = 12),
#   chains = 4,
#   iter = 2000,
#   warmup = 1000,
#   seed = 124,
#   cores = 4,
#   backend = "cmdstanr"
# )
# 
# m2b_zga <- add_criterion(m2b_zga, "loo")
# 
# saveRDS(m2b_zga, file = here("unified_models/unified_model_results_zga_life_tax_popb.rds"))
# m2b_zga = readRDS(file = here("unified_models/unified_model_results_zga_life_tax_popb.rds"))

m3_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 + population) +  (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + (1 + population) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture + (1 + population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m3_zln <- add_criterion(m3_zln, "loo")

saveRDS(m3_zln, file = here("unified_models/unified_model_results_zln_life_tax_poptls.rds"))
m3_zln = readRDS(file = here("unified_models/unified_model_results_zln_life_tax_poptls.rds"))

m3b_zln <- brm(
  formula = bf(
    bd_load_co ~ 1 + life_stage_simple * taxon_capture + (1 + population) +  (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + (1 + population) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture + (1 + population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m3b_zln <- add_criterion(m3b_zln, "loo")

saveRDS(m3b_zln, file = here("unified_models/unified_model_results_zln_life_tax_poptls_nodens.rds"))
m3b_zln = readRDS(file = here("unified_models/unified_model_results_zln_life_tax_poptls_nodens.rds"))

# m4_zln <- brm(
#   formula = bf(
#     bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + temp_c_30_z + (1 + population) +  (1 | population:taxon_capture:life_stage_simple),
#     hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + temp_c_15_z + (1 + population) +  (1 | population:taxon_capture:life_stage_simple),
#     sigma ~ 1 + taxon_capture + (1 + population) + (1 | population:taxon_capture)
#   ),
#   data = brms_data,
#   family = hurdle_lognormal(),
#   prior = model_priors,
#   sample_prior = "yes",
#   control = list(adapt_delta = 0.95, max_treedepth = 12),
#   chains = 4,
#   iter = 2000,
#   warmup = 1000,
#   seed = 124,
#   cores = 4,
#   backend = "cmdstanr"
# )
# m4_zln <- add_criterion(m4_zln, "loo")
# 
# saveRDS(m4_zln, file = "unified_models/unified_model_results_zln_life_tax_pop_env.rds")
# m4_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_pop_env.rds")

m5_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m5_zln <- add_criterion(m5_zln, "loo")

saveRDS(m5_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls_env2.rds")
m5_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls_env2.rds")


# m5b_zln <- brm(
#   formula = bf(
#     bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 + precip_mm_30_z + temp_c_30_z | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
#     hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 + precip_mm_15_z + temp_c_15_z | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
#     sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
#   ),
#   data = brms_data,
#   family = hurdle_lognormal(),
#   prior = model_priors,
#   sample_prior = "yes",
#   control = list(adapt_delta = 0.95, max_treedepth = 12),
#   chains = 4,
#   iter = 2000,
#   warmup = 1000,
#   seed = 124,
#   cores = 4,
#   backend = "cmdstanr"
# )
# 
# m5b_zln <- add_criterion(m5b_zln, "loo")
# 
# saveRDS(m5b_zln, file = "unified_models/unified_model_results_zln_life_tax_poptlsenv_env2.rds")
# m5b_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptlsenv_env2.rds")

m5c_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m5c_zln <- add_criterion(m5c_zln, "loo")

saveRDS(m5c_zln, file = "unified_models/unified_model_results_zln_life_tax_poptlsenv2_env2.rds")
m5c_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptlsenv2_env2.rds")

# m5d_zln <- brm(
#   formula = bf(
#     bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 + precip_mm_30_z + temp_c_30_z | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
#     hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 + precip_mm_15_z + temp_c_15_z | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
#     sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
#   ),
#   data = brms_data,
#   family = hurdle_lognormal(),
#   prior = model_priors,
#   sample_prior = "yes",
#   control = list(adapt_delta = 0.95, max_treedepth = 12),
#   chains = 4,
#   iter = 2000,
#   warmup = 1000,
#   seed = 124,
#   cores = 4,
#   backend = "cmdstanr"
# )
# 
# m5d_zln <- add_criterion(m5d_zln, "loo")
# 
# saveRDS(m5d_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls2env_env2.rds")
# m5d_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2env_env2.rds")


# m5e_zln <- brm(
#   formula = bf(
#     bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 + precip_mm_30_z + temp_c_30_z | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
#     hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 + precip_mm_15_z + temp_c_15_z | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
#     sigma ~ 1 + life_stage_simple * taxon_capture +  (1 | population) + (1 | population:taxon_capture:life_stage_simple)
#   ),
#   data = brms_data,
#   family = hurdle_lognormal(),
#   prior = model_priors,
#   sample_prior = "yes",
#   control = list(adapt_delta = 0.95, max_treedepth = 12),
#   chains = 4,
#   iter = 2000,
#   warmup = 1000,
#   seed = 124,
#   cores = 4,
#   backend = "cmdstanr"
# )
# 
# m5e_zln <- add_criterion(m5e_zln, "loo")
# 
# saveRDS(m5e_zln, file = "unified_models/unified_model_results_zln_life_tax_poptlsenv_env2_sigls.rds")
# m5e_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptlsenv_env2_sigls.rds")

m5f_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m5f_zln <- add_criterion(m5f_zln, "loo")

saveRDS(m5f_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_env2.rds")
m5f_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_env2.rds")

m5g_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 | population) + (1 + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + (1 | population) + (1 + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m5g_zln <- add_criterion(m5g_zln, "loo")

saveRDS(m5g_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_30.rds")
m5g_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_30.rds")

m6_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 + (1 | population) + (1 + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_sp_z + precip_mm_15_sp_z2 + temp_c_15_sp_z + temp_c_15_sp_z2 + (1 | population) + (1 + precip_mm_15_sp_z + precip_mm_15_sp_z2 + temp_c_15_sp_z + temp_c_15_sp_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m6_zln <- add_criterion(m6_zln, "loo")

saveRDS(m6_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls2envsp2_envsp2.rds")
m6_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2envsp2_envsp2.rds")

m6b_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 | population) + (1 + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + (1 | population) + (1 + precip_mm_15_sp_z + precip_mm_15_sp_z2 + temp_c_15_sp_z + temp_c_15_sp_z2 | taxon_capture) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m6b_zln <- add_criterion(m6b_zln, "loo")

saveRDS(m6b_zln, file = "unified_models/unified_model_results_zln_life_tax_popt2envsp2.rds")
m6b_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_popt2envsp2.rds")

m6c_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 + (1 | population) + (1 + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 + (1 | population) + (1 + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m6c_zln <- add_criterion(m6c_zln, "loo")

saveRDS(m6c_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls2envsp2_envsp2_30.rds")
m6c_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2envsp2_envsp2_30.rds")

m6d_zln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 | population) + (1 + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + (1 | population) + (1 + precip_mm_30_sp_z + precip_mm_30_sp_z2 + temp_c_30_sp_z + temp_c_30_sp_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m6d_zln <- add_criterion(m6d_zln, "loo")

saveRDS(m6d_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls2envsp2_30.rds")
m6d_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2envsp2_30.rds")

m7_zln <- brm(
  formula = bf(
    bd_load_co ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),
    sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  prior = model_priors,
  sample_prior = "yes",
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 124,
  cores = 4,
  backend = "cmdstanr"
)

m7_zln <- add_criterion(m7_zln, "loo")

saveRDS(m7_zln, file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_env2_nodens.rds")
m7_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_env2_nodens.rds")



```

## Model comparison

Model formula:

bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 + (1 | population) + (1 + precip_mm_30_z + precip_mm_30_z2 + temp_c_30_z + temp_c_30_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),

hu ~ 1 + life_stage_simple * taxon_capture + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 + (1 | population) + (1 + precip_mm_15_z + precip_mm_15_z2 + temp_c_15_z + temp_c_15_z2 | taxon_capture:life_stage_simple) + (1 | population:taxon_capture:life_stage_simple),

sigma ~ 1 + taxon_capture +  (1 | population) + (1 | population:taxon_capture)
```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Show model comparison code"
# model comparison and selection

(loo_comp_out = loo_compare(null_zln,
                            nullb_zln, # no density
                            m1_zln,
                            # m2_zln,
                            m2b_zln,
                            m3_zln,
                            m3b_zln,  # no density
                            # m4_zln,
                            m5_zln,
                            # m5b_zln,
                            m5c_zln,
                            # m5d_zln,
                            # m5e_zln,
                            m5f_zln,
                            m5g_zln,
                            m6_zln,
                            m6b_zln,
                            m6c_zln,
                            m6d_zln
                            ))
```

## Model checks

### Correlation checks
```{r}
#| eval: true
#| code-fold: true
#| code-summary: "Show model checks code"
#| fig-height: 6
#| fig-width: 8

m5g_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_30.rds")
VarCorr(m5g_zln)
```

### Posterios predictive checks
```{r}
#| eval: true
#| code-fold: true
#| code-summary: "Show model checks code (fixed effects)"
#| fig-height: 6
#| fig-width: 8

color_scheme_set("viridis")

# mcmc_plot(m5c_zln, type = "trace")
# mcmc_plot(m6b_zln, type = "dens")
# mcmc_plot(m5f_zln, type = "intervals")
# mcmc_plot(m6b_zln, type = "acf")

# pp_check(null_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m1_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m2_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m2b_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m2b_zga, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m3_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m4_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m5_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m5b_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m5c_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m5d_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()
# 
# pp_check(m5e_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
#   scale_x_log10()

pp_check(m5g_zln, type = "dens_overlay", prefix = "ppc", ndraws = 100) +
  scale_x_log10()
```

### Prior checks
```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Show prior checks code"
#| fig-height: 6
#| fig-width: 8

mcmc_plot(m5f_zln, type = "dens", variable = c("prior_Intercept", "b_Intercept")) +
  xlim(-20, 20)

mcmc_plot(m5f_zln, type = "dens", variable = c("prior_b", "b_taxon_capturecolostethus_panamansis", "b_taxon_capturelithobates_blairi", 
"b_taxon_capturelithobates_sphenocephalus", "b_taxon_capturelithobates_warszewitschii", 
"b_taxon_capturepseudacris_crucifer", "b_taxon_capturerana_catesbeiana", 
"b_taxon_capturerana_clamitans", "b_taxon_capturerana_muscosa", 
"b_taxon_capturerana_pipiens", "b_taxon_capturerana_sierrae", 
"b_taxon_capturesilverstoneia_flotator")) +
  xlim(-10, 10)

mcmc_plot(m5f_zln, type = "dens", variable = c("prior_Intercept_sigma", "b_sigma_Intercept")) +
  xlim(-2, 2)

mcmc_plot(m5f_zln, type = "dens", variable = c("prior_b_sigma", "b_sigma_taxon_capturecolostethus_panamansis", "b_sigma_taxon_capturelithobates_blairi", 
"b_sigma_taxon_capturelithobates_sphenocephalus", "b_sigma_taxon_capturelithobates_warszewitschii", 
"b_sigma_taxon_capturepseudacris_crucifer", "b_sigma_taxon_capturerana_catesbeiana", 
"b_sigma_taxon_capturerana_clamitans", "b_sigma_taxon_capturerana_muscosa", 
"b_sigma_taxon_capturerana_pipiens", "b_sigma_taxon_capturerana_sierrae", 
"b_sigma_taxon_capturesilverstoneia_flotator")) +
  xlim(-2, 2)

mcmc_plot(m5f_zln, type = "dens", variable = c("prior_Intercept_hu", "b_hu_Intercept")) +
  xlim(-15, 15)

mcmc_plot(m5f_zln, type = "dens", variable = c("prior_b_hu", "b_hu_life_stage_simplesubadult", "b_hu_taxon_capturecolostethus_panamansis", 
"b_hu_taxon_capturelithobates_blairi", "b_hu_taxon_capturelithobates_sphenocephalus", 
"b_hu_taxon_capturelithobates_warszewitschii", "b_hu_taxon_capturepseudacris_crucifer", 
"b_hu_taxon_capturerana_catesbeiana", "b_hu_taxon_capturerana_clamitans", 
"b_hu_taxon_capturerana_muscosa", "b_hu_taxon_capturerana_pipiens", 
"b_hu_taxon_capturerana_sierrae", "b_hu_taxon_capturesilverstoneia_flotator")) +
  xlim(-5, 5)

```

## Processing and visualization
```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Show processing & visualization functions"

extract_abbr <- function(taxon) {
  parts <- strsplit(taxon, "_")[[1]]
  genus_abbr <- substr(parts[1], 1, 2)
  species_abbr <- substr(parts[2], 1, 2)
  paste0(genus_abbr, species_abbr)
}

load_model = function(taxon, template = "model_results_zln_life_tax_sea_pop_xxxx.rds"){
  filename = gsub("xxxx", extract_abbr(taxon), template)
  cat(taxon, ":\n\t", filename, "\n")
  return(readRDS(filename))
}

model_report = function(model_m){
  summary(model_m)
  plot((model_m), ask = FALSE)
  plot(conditional_effects(model_m), ask = FALSE)
  pp_check(model_m) +
    scale_x_log10()
}
get_species_name = function(taxon, newline = FALSE) {
  species_name = str_to_sentence(gsub("_", " ", taxon))
  if (newline) {
    species_name = gsub(" ", "\n", species_name)
  }
  return(species_name)
}

samp_pos = function(m_zln, lifestage, season, n, s = 1){
  pp = data.frame(
    life_stage_simple = lifestage,
    season = season,
    population = "NA"
  ) %>%
    slice(rep(1:n(), s))
  
  p_samp = posterior_predict(m_zln,
                             newdata = pp,
                             ndraws = n,
                             allow_new_levels = TRUE)
}

# draws
collect_draws = function(m_spec){
  model_vars = get_variables(m_spec)
  
  all_life_stage_simple = sort(unique(m_spec$data$life_stage_simple))
  all_taxon_capture = sort(unique(m_spec$data$taxon_capture))
  all_prefixes = c("b",
                   "b_hu",
                   "b_sigma")
  
  param_grid = crossing(prefix = all_prefixes,
                        life_stage_simple = all_life_stage_simple,
                        taxon_capture = all_taxon_capture) %>%
    mutate(param_name = paste0(prefix, "_", taxon_capture, "_", life_stage_simple),
           t_intercept = paste0(prefix, "_Intercept"),
           t_lss = if_else(life_stage_simple == all_life_stage_simple[1],
                               NA,
                               paste0(prefix, "_life_stage_simple", life_stage_simple)),
           t_tc = if_else(taxon_capture == all_taxon_capture[1],
                              NA,
                              paste0(prefix, "_taxon_capture", taxon_capture)),
           t_lss_tc = if_else(life_stage_simple == all_life_stage_simple[1] |
                                taxon_capture == all_taxon_capture[1],
                              NA,
                              paste0(prefix, "_life_stage_simple", life_stage_simple, "__", "taxon_capture", taxon_capture))) %>%
    unite(formula, t_intercept, t_lss, t_tc, t_lss_tc, sep = " + ", remove = FALSE, na.rm = TRUE) %>%
    mutate(expr = map(formula, ~ rlang::parse_expr(.x)))
  
  # drop sigma life_stage dependence
  sig_temp = param_grid %>%
    filter((prefix == "b_sigma" & life_stage_simple == "adult")) %>%
    mutate(life_stage_simple = "subadult",
           param_name = gsub("_adult", "_subadult", param_name))
  
  param_grid = param_grid %>%
    filter(!(prefix == "b_sigma" & life_stage_simple == "subadult")) %>%
    bind_rows(sig_temp)
  
  expr_list = set_names(param_grid$expr, param_grid$param_name)
  
  m_spread = m_spec %>%
    spread_draws(`b_.*`, regex = TRUE)
  colnames(m_spread) = gsub(":", "__", colnames(m_spread))
  
  m_spread_mutated = reduce(
    .x = names(expr_list),
    .init = m_spread,
    .f = function(df, param) {
      mutate(df,
             !!param := eval(expr_list[[param]], envir = df))
    }
  ) %>%
    select(.draw,
           all_of(param_grid$param_name)) %>%
    pivot_longer(cols = param_grid$param_name, names_to = "param_name") %>%
    left_join(param_grid %>%
                select(param_name, prefix, taxon_capture, life_stage_simple), by = "param_name") %>%
    pivot_wider(id_cols = c(.draw, taxon_capture, life_stage_simple),
                names_from = prefix) %>%
    left_join(m_spec %>%
                spread_draws(c(sd_population__Intercept,
                               sd_population__hu_Intercept)), by = ".draw") %>%
    mutate(p0 = plogis(b_hu),
           prevalence = 1 - p0,
           sigma = exp(b_sigma),
           sd_eff_bd_load = sqrt(sigma^2 + sd_population__Intercept^2)) %>%
    rename(sd_eff_hu = sd_population__hu_Intercept) %>%
    select(.draw,
           .chain,
           .iteration,
           everything())
  
  return(m_spread_mutated)
}

density_mat = function(lower, upper, len, draws){
  density_grid = seq(lower, upper, length.out = len)
  
  grouped_draws = draws %>%
    group_by(taxon_capture, life_stage_simple) %>%
    group_split()
  
  group_summaries = map(grouped_draws, function(group_df) {
    # Get the group labels
    life_stage = unique(group_df$life_stage_simple)
    taxon_capture = unique(group_df$taxon_capture)
    
    # Compute density matrices
    pdf_density_mat = pmap(
      list(group_df$b, group_df$sigma, group_df$p0),
      function(b, sigma, p0) {
        dnorm(density_grid, mean = b, sd = sigma) * (1 - p0)
      }
    ) %>%
      simplify2array() %>%
      t()
    
    ccdf_density_mat = pmap(
      list(group_df$b, group_df$sigma, group_df$p0),
      function(b, sigma, p0) {
        (1 - pnorm(density_grid, mean = b, sd = sigma)) * (1 - p0)
      }
    ) %>%
      simplify2array() %>%
      t()
    
    
    # Summary statistics:
    pdf_q.5 = apply(pdf_density_mat, 2, quantile, probs = 0.5)
    pdf_q.25 = apply(pdf_density_mat, 2, quantile, probs = 0.25)
    pdf_q.75 = apply(pdf_density_mat, 2, quantile, probs = 0.75)
    
    ccdf_q.5 = apply(ccdf_density_mat, 2, quantile, probs = 0.5)
    ccdf_q.25 = apply(ccdf_density_mat, 2, quantile, probs = 0.25)
    ccdf_q.75 = apply(ccdf_density_mat, 2, quantile, probs = 0.75)
    
    # Return a tidy tibble for plotting or analysis
    tibble(
      taxon_capture,
      life_stage_simple = life_stage,
      density = density_grid,
      pdf_median = pdf_q.5,
      pdf_lower = pdf_q.25,
      pdf_upper = pdf_q.75,
      ccdf_median = ccdf_q.5,
      ccdf_lower = ccdf_q.25,
      ccdf_upper = ccdf_q.75
    )
  })
  
  summary_df <- bind_rows(group_summaries)
}

samp_pos = function(m_zln, lifestage, season, n){

  pp = data.frame(
    life_stage_simple = lifestage,
    season = season,
    population = "NA"
  )
  
  p_samp = posterior_predict(m_zln,
                             newdata = pp,
                             ndraws = n,
                             allow_new_levels = TRUE)

}

sample_posterior_life_sea = function(m_zln, species_name, n = 10000){
  ps_adult_lluvia = samp_pos(m_zln, "adult", "lluvia", n)
  ps_adult_seca = samp_pos(m_zln, "adult", "seca", n)
  ps_subadult_lluvia = samp_pos(m_zln, "subadult", "lluvia", n)
  ps_subadult_seca = samp_pos(m_zln, "subadult", "seca", n)

  df_samps_adult_lluvia = data.frame(
    life_stage_simple = "adult",
    season = "lluvia",
    bd_load = ps_adult_lluvia
  )

  df_samps_adult_seca = data.frame(
    life_stage_simple = "adult",
    season = "seca",
    bd_load = ps_adult_seca
  )

  df_samps_subadult_lluvia = data.frame(
    life_stage_simple = "subadult",
    season = "lluvia",
    bd_load = ps_subadult_lluvia
  )
  
  df_samps_subadult_seca = data.frame(
    life_stage_simple = "subadult",
    season = "seca",
    bd_load = ps_subadult_seca
  )

  df_samps = bind_rows(df_samps_adult_lluvia,
                       df_samps_adult_seca,
                       df_samps_subadult_lluvia,
                       df_samps_subadult_seca) %>%
    mutate(bd_load = ifelse(bd_load < 0.3, 0, bd_load),
           log_bd_load = log(bd_load + 1),
           taxon_capture = species_name)
}

sample_posterior_life_1s = function(m_zln, species_name, n = 10000){
  ps_adult_lluvia = samp_pos(m_zln, "adult", "lluvia", n)
  ps_subadult_lluvia = samp_pos(m_zln, "subadult", "lluvia", n)

  df_samps_adult_lluvia = data.frame(
    life_stage_simple = "adult",
    season = "lluvia",
    bd_load = ps_adult_lluvia
  )

  df_samps_subadult_lluvia = data.frame(
    life_stage_simple = "subadult",
    season = "lluvia",
    bd_load = ps_subadult_lluvia
  )

  df_samps = bind_rows(df_samps_adult_lluvia,
                       df_samps_subadult_lluvia) %>%
    mutate(bd_load = ifelse(bd_load < 0.3, 0, bd_load),
           log_bd_load = log(bd_load + 1),
           taxon_capture = species_name)
}

simulate_bd_load = function(draws, n_per_draw = 10, downsample = NA) {
  if (!is.na(downsample) & downsample < length(unique(draws$.draw))) {
    draws = draws %>%
      group_by(taxon_capture, life_stage_simple) %>%
      slice_sample(n = downsample) %>%
      ungroup()
  }
  
  
  draws %>%
    filter(!is.na(b),
           !is.na(sigma)) %>%
    group_by(.draw, taxon_capture, life_stage_simple) %>%
    reframe(
      log_bd_load_co_density = rnorm(n_per_draw, mean = b, sd = sigma),
      .id = "sim_id"
    ) %>%
    ungroup()
}

wilson_ci = function(p_hat, n, conf.level = 0.95) {
  z <- qnorm(1 - (1 - conf.level) / 2)
  
  denominator <- 1 + (z^2 / n)
  centre_adjusted_probability <- p_hat + (z^2 / (2 * n))
  adjusted_standard_deviation <- sqrt((p_hat * (1 - p_hat) / n) + (z^2 / (4 * n^2)))
  
  lower_bound <- (centre_adjusted_probability - z * adjusted_standard_deviation) / denominator
  upper_bound <- (centre_adjusted_probability + z * adjusted_standard_deviation) / denominator
  
  return(c(lower_bound = lower_bound, upper_bound = upper_bound))
}

wilson_ci_lower = function(p_hat, n, conf.level = 0.95) {
  ws = wilson_ci(p_hat, n, conf.level)
  return(ws[1])
}

wilson_ci_upper = function(p_hat, n, conf.level = 0.95) {
  ws = wilson_ci(p_hat, n, conf.level)
  return(ws[2])
}

sample_stats = function(df) {
  df %>%
    group_by(taxon_capture,
             life_stage_simple) %>%
    summarise(n = n(),
              n_pos = sum(bd_load_co > 0),
              bd_prevalence = sum(bd_load_co > 0) / n(),
              bd_prevalence_ci_lower = wilson_ci_lower(bd_prevalence, n(), 0.95),
              bd_prevalence_ci_upper = wilson_ci_upper(bd_prevalence, n(), 0.95),
              min_log_pos_load_dens = min(log_bd_load_co_density[bd_load_co > 0]),
              q_25_log_pos_load_dens = quantile(log_bd_load_co_density[bd_load_co > 0], probs = 0.25),
              q_50_log_pos_load_dens = quantile(log_bd_load_co_density[bd_load_co > 0], probs = 0.50),
              q_75_log_pos_load_dens = quantile(log_bd_load_co_density[bd_load_co > 0], probs = 0.75),
              max_log_pos_load_dens = max(log_bd_load_co_density[bd_load_co > 0]),
              se = sqrt(bd_prevalence * (1 - bd_prevalence) / n),
              .groups = "drop") %>%
    mutate(label_y = case_match(life_stage_simple,
                                "adult" ~ .98,
                                "subadult" ~ .95))
}
```

# Results
Results are broken out first by species, then combined for comparison between species

## Hypothesis testing
```{r}
#| eval: true
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 10

# model_select = m3_zln
# model_select = m5f_zln
# model_select = m5f_zln
model_select = m5g_zln

species = brms_data %>%
  select(taxon_capture) %>%
  distinct() %>%
  arrange(taxon_capture)

# sig_taxon = spread_draws(m5f_zln, `b_sigma.*`, regex = TRUE) %>%
#   mutate(b_sigma_taxon_captureanaxyrus_americanus = 0) %>%
#   pivot_longer(starts_with("b_sigma_taxon"),
#                names_to = "parameter",
#                values_to = "sigma_adj") %>%
#   mutate(taxon_capture = gsub("b_sigma_taxon_capture", "", parameter),
#          sigma = b_sigma_Intercept + sigma_adj) %>%
#   select(.draw,
#          taxon_capture,
#          sigma)

# sig_taxon_med = sig_taxon %>%
#   group_by(taxon_capture) %>%
#   summarize(sigma_med = median(sigma),
#             .groups = "drop")

# prevalence
hu_taxon_subadult = spread_draws(model_select, `b_hu_life_stage_simplesubadult.*`, regex = TRUE) %>%
  mutate(`b_hu_life_stage_simplesubadult:taxon_captureanaxyrus_americanus` = 0) %>%
  pivot_longer(starts_with("b_hu_life_stage_simplesubadult:taxon_capture"),
               names_to = "parameter",
               values_to = "hu_adj") %>%
  mutate(taxon_capture = gsub("b_hu_life_stage_simplesubadult:taxon_capture", "", parameter),
         hu_subadult = b_hu_life_stage_simplesubadult + hu_adj,
         species = get_species_name(taxon_capture)) %>%
  group_by(species) %>%
  mutate(sp_sd = sd(hu_subadult)) %>%
  ungroup() %>%
  mutate(hu_subadult_sc = hu_subadult / sp_sd)

log_th = pi / sqrt(3)

hu_taxon_subadult_rope = hu_taxon_subadult %>%
  mutate(in_rope = abs(hu_subadult) <= log_th) %>%
  group_by(species) %>%
  summarize(n = n(),
            pd = pd(hu_subadult)$pd,
            hdi = hdi(hu_subadult, ci = 0.89),
            ratio_rope = sum(in_rope) / n(),
            ratio_positive = sum(hu_subadult > 0) / n(),
            ratio_negative = sum(hu_subadult < 0) / n(),
            ratio_net = ratio_positive - ratio_negative,
            hu_median = median(hu_subadult),
            hu_mean = mean(hu_subadult),
            .groups = "drop")

# absolute
ggplot(hu_taxon_subadult, aes(x = hu_subadult)) +
  geom_vline(xintercept = 0, alpha = 0.5) +
  geom_density(fill = "yellow", alpha = 0.5) +
  facet_wrap("species") +
  xlim(-5, 5) +
  theme_minimal()

# rope
ggplot(hu_taxon_subadult, aes(x = hu_subadult)) +
  geom_density(fill = "yellow", alpha = 0.5) +
  geom_vline(xintercept = 0, alpha = 0.5) +
  facet_wrap("species") +
  # geom_vline(xintercept=0) +
  annotate("rect", 
           xmin = -log_th, xmax = log_th, 
           ymin = -Inf, ymax = Inf,
           fill = "red", alpha = 0.3) +
  geom_text(data = hu_taxon_subadult_rope,
            aes(x = -2.5,
                y = 0.75,
                label = paste0("ROPE: ", as.character(round(ratio_rope, digits = 4)))),
            size = 3) +
  xlim(-5, 5) +
  theme_minimal()

# load
b_taxon_subadult = spread_draws(model_select, `b_life_stage_simplesubadult.*`, regex = TRUE) %>%
  mutate(`b_life_stage_simplesubadult:taxon_captureanaxyrus_americanus` = 0) %>%
  pivot_longer(starts_with("b_life_stage_simplesubadult:taxon_capture"),
               names_to = "parameter",
               values_to = "b_adj") %>%
  mutate(taxon_capture = gsub("b_life_stage_simplesubadult:taxon_capture", "", parameter),
         b_subadult = b_life_stage_simplesubadult + b_adj,
         species = get_species_name(taxon_capture)) %>%
  group_by(species) %>%
  mutate(sp_sd = sd(b_subadult)) %>%
  ungroup() %>%
  mutate(b_subadult_sc = b_subadult / sp_sd)



b_taxon_subadult_rope = b_taxon_subadult %>%
  mutate(in_rope = abs(b_subadult_sc) <= 0.1) %>%
  group_by(species, sp_sd) %>%
  summarize(n = n(),
            pd = pd(b_subadult)$pd,
            hdi = hdi(b_subadult, ci = 0.89),
            ratio_rope = sum(in_rope) / n(),
            ratio_positive = sum(b_subadult_sc > 0) / n(),
            ratio_negative = sum(b_subadult_sc < 0) / n(),
            ratio_net = ratio_positive - ratio_negative,
            b_median = median(b_subadult),
            b_mean = mean(b_subadult),
            b_sc_median = median(b_subadult_sc),
            b_sc_mean = mean(b_subadult_sc),
            .groups = "drop")

# absolute
ggplot(b_taxon_subadult, aes(x = b_subadult)) +
  geom_vline(xintercept = 0, alpha = 0.5) +
  geom_density(fill = "blue", alpha = 0.5) +
  facet_wrap("species") +
  theme_minimal()

# rope
ggplot(b_taxon_subadult, aes(x = b_subadult_sc)) +
  geom_density(fill = "blue", alpha = 0.5) +
  facet_wrap("species") +
  # geom_vline(xintercept=0) +
  annotate("rect", 
           xmin = -0.1, xmax = 0.1, 
           ymin = -Inf, ymax = Inf,
           fill = "red", alpha = 0.3) +
  geom_text(data = b_taxon_subadult_rope,
            aes(x = -2.5,
                y = 1,
                label = paste0("ROPE: ", as.character(round(ratio_rope, digits = 4)))),
            size = 3) +
  xlim(-5, 5) +
  theme_minimal()

# unscaled rope
ggplot(b_taxon_subadult, aes(x = b_subadult)) +
  geom_vline(xintercept = 0, alpha = 1) +
  geom_density(fill = "blue", alpha = 0.5) +
  geom_rect(data = b_taxon_subadult_rope, 
            aes(xmin = -0.1 * sp_sd, xmax = 0.1 * sp_sd, ymin = -Inf, ymax = Inf, 
                fill = "red"), alpha = 0.3, inherit.aes = FALSE) +
  facet_wrap("species") +
  theme_minimal() +
  xlim(-4, 6)
  

taxon_subadult = b_taxon_subadult %>%
  left_join(hu_taxon_subadult, by = c(".draw", ".iteration", ".chain", "taxon_capture", "species"))

# net direction
taxon_subadult_rope = hu_taxon_subadult_rope %>%
  full_join(b_taxon_subadult_rope, by = "species", suffix = c("_hu", "_b"))

ggplot(taxon_subadult_rope, aes(x = ratio_net_hu, y = ratio_net_b, color = species)) +
  geom_vline(xintercept = 0, color = "#aaa") +
  geom_hline(yintercept = 0, color = "#aaa") + 
  geom_point() +
  geom_text_repel(aes(label = species)) +
  xlim(-1, 1) +
  ylim(-1, 1) +
  theme_minimal()

# rope
ggplot(taxon_subadult_rope, aes(x = 1 / ratio_rope_hu, y = 1 / ratio_rope_b, color = species)) +
  geom_vline(xintercept = 20, color = "#aaa") +
  geom_hline(yintercept = 20, color = "#aaa") + 
  geom_point() +
  geom_text_repel(aes(label = species)) +
  theme_minimal() +
  scale_x_log10() +
  scale_y_log10()

# medians
ggplot(taxon_subadult_rope, aes(x = hu_median, y = b_median, color = species)) +
  geom_vline(xintercept = 0, color = "#aaa") +
  geom_hline(yintercept = 0, color = "#aaa") + 
  geom_point() +
  geom_text_repel(aes(label = species)) +
  theme_minimal()

ggplot(taxon_subadult_rope, aes(x = hu_median, y = b_median, color = species)) +
  stat_ellipse(data = taxon_subadult, aes(x = hu_subadult, y = b_subadult), level = 0.89, alpha = 0.3) +
  geom_vline(xintercept = 0, color = "#aaa") +
  geom_hline(yintercept = 0, color = "#aaa") + 
  geom_point() +
  geom_text_repel(aes(label = species)) +
  theme_minimal()


# # relative spread...
# relative_b = spread_draws(model_select, `^b_Intercept$|^b_life_stage_simple.*|^b_taxon_capture.*`, regex = TRUE) %>%
#   mutate(`b_taxon_captureanaxyrus_americanus` = 0,
#          `b_life_stage_simplesubadult:taxon_captureanaxyrus_americanus` = 0) %>%
#   pivot_longer(
#     cols = starts_with(c("b_taxon", "b_life_stage_simplesubadult:taxon")),
#     names_to = c(".value", "taxon_capture"),
#     names_pattern = "(.*taxon_capture)([a-z]*_[a-z]*$)") %>%
#   mutate(adult_b = b_Intercept + b_taxon_capture,
#          subadult_b = b_Intercept + b_taxon_capture + b_life_stage_simplesubadult + `b_life_stage_simplesubadult:taxon_capture`,
#          adult_relative_b = adult_b / subadult_b,
#          subadult_relative_b = subadult_b / adult_b)
# 
# relative_hu = spread_draws(model_select, `^b_hu_Intercept$|^b_hu_life_stage_simple.*|^b_hu_taxon_capture.*`, regex = TRUE) %>%
#   mutate(`b_hu_taxon_captureanaxyrus_americanus` = 0,
#          `b_hu_life_stage_simplesubadult:taxon_captureanaxyrus_americanus` = 0) %>%
#   pivot_longer(
#     cols = starts_with(c("b_hu_taxon", "b_hu_life_stage_simplesubadult:taxon")),
#     names_to = c(".value", "taxon_capture"),
#     names_pattern = "(.*taxon_capture)([a-z]*_[a-z]*$)") %>%
#   mutate(adult_hu = b_hu_Intercept + b_hu_taxon_capture,
#          subadult_hu = b_hu_Intercept + b_hu_taxon_capture + b_hu_life_stage_simplesubadult + `b_hu_life_stage_simplesubadult:taxon_capture`,
#          adult_relative_hu = adult_hu / subadult_hu,
#          subadult_relative_hu = subadult_hu / adult_hu)
# 
# relative_params = relative_b %>%
#   left_join(relative_hu, by = c(".chain", ".iteration", ".draw", "taxon_capture"))
# 
# relative_params_agg = relative_params %>%
#   group_by(taxon_capture) %>%
#   summarize(adult_relative_b_median = median(adult_relative_b),
#             adult_relative_hu_median = median(adult_relative_hu),
#             subadult_relative_b_median = median(subadult_relative_b),
#             subadult_relative_hu_median = median(subadult_relative_hu))
# 
# ggplot(relative_params, aes(x = subadult_b, y = subadult_hu, color = taxon_capture)) +
#   stat_ellipse()
# 
# ggplot(relative_params, aes(x = subadult_relative_b, y = subadult_relative_hu, color = taxon_capture)) +
#   stat_ellipse()
# 
# ggplot(relative_params_agg, aes(x = adult_relative_b_median, y = adult_relative_hu_median, color = taxon_capture)) +
#   stat_ellipse(data = relative_params, aes(x = adult_relative_b, y = adult_relative_hu), level = 0.5, alpha = 0.3) +
#   geom_vline(xintercept = 1, color = "#aaa") +
#   geom_hline(yintercept = 1, color = "#aaa") + 
#   geom_point() +
#   geom_text_repel(aes(label = taxon_capture)) +
#   theme_minimal()
# 
# ggplot(relative_params_agg, aes(x = subadult_relative_hu_median, y = subadult_relative_b_median, color = taxon_capture)) +
#   geom_point() +
#   geom_text_repel(aes(label = taxon_capture)) +
#   geom_vline(xintercept = 1, color = "#aaa") +
#   geom_hline(yintercept = 1, color = "#aaa")

```

## Collective results
```{r}
#| eval: true
#| echo: true
#| output: false
#| code-fold: true
#| code-summary: Show code

# m5g_zln = readRDS(file = "unified_models/unified_model_results_zln_life_tax_poptls2env2_env2.rds")

choice_model = m5g_zln

model_data = brms_data

draws_all = collect_draws(choice_model) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

density_mat_all = density_mat(log(0.5), 20, 100, draws_all) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

sim_load_all = simulate_bd_load(draws_all, 10, 1000) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

obs_stats_all = sample_stats(model_data) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

```

::: {.panel-tabset}
### Observed Prevalence
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# observed prevalence
ggplot(obs_stats_all, aes(y = bd_prevalence, x = species, color = life_stage_simple)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = bd_prevalence_ci_lower, ymax = bd_prevalence_ci_upper),
                width = 0.2,
                position = position_dodge(width = 0.5)) +
  theme_minimal() +
  ggtitle("Observed prevalence") +
  xlab("Species") +
  ylab("Bd prevalence [-]\n(with 95% CI)") +
  labs(color = "Life stage") +
  geom_text(aes(label = paste0("n=", n),  y = label_y),
          position = position_dodge(width = 0.5)) +
  ylim(0, 1) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

### Modeled Prevalence 
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# model prevalence
ggplot(draws_all, aes(prevalence, x = species, color = life_stage_simple)) +
  geom_boxplot(coef = NULL) + 
  theme_minimal() +
  ggtitle("Modeled prevalence") +
  xlab("Species") +
  ylab("Bd prevalence [-]\n") +
  labs(color = "Life stage") +
  ylim(0, 1) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

### Observed Bd load
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# obsevation bd load
ggplot(model_data %>%
         mutate(species = get_species_name(taxon_capture, newline = TRUE)) %>%
         filter(bd_load_co > 0), aes(log_bd_load_co_density, x = species, color = life_stage_simple)) +
  geom_boxplot() + 
  theme_minimal() +
  ggtitle("Observed Bd-positive load") +
  xlab("Species") +
  ylab("log(Bd load density) [-]") +
  labs(color = "Life stage") +
  geom_text(
    data = obs_stats_all,
    aes(
      x = species,
      y = max(model_data$log_bd_load_co_density) * label_y * 1.05,
      label = paste0("n=", n_pos),
      group = life_stage_simple
    ),
    position = position_dodge(width = 0.75),
    vjust = 0
  ) +
  ylim(log(0.5), 19) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

### Modeled Bd load
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# modeled bd load
ggplot(sim_load_all %>%
         filter(log_bd_load_co_density > 0.5), aes(log_bd_load_co_density, x = species, color = life_stage_simple)) +
  geom_boxplot() + 
  theme_minimal() +
  ggtitle("Modeled Bd-positive load") +
  xlab("Species") +
  ylab("log(Bd load density) [-]") +
  labs(color = "Life stage") +
  ylim(log(0.5), 20) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

### Modeled Bd load PDF
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# PDF -- facet by species
ggplot(density_mat_all, aes(x = density,
                            y = pdf_median,
                            color = life_stage_simple, 
                            fill = life_stage_simple)) +
  geom_ribbon(aes(ymin = pdf_lower,
                  ymax = pdf_upper), 
              alpha = 0.15,
              color = NA) +
  geom_line() +
  theme_minimal() +
  ggtitle("Modeled PDF of Bd-positive load") +
  labs(color = "Life stage",
       fill = "Life stage") +
  xlab("log(Bd load) [-]") +
  ylab("Median probability density [-]\n(with 25th to 75th percentiles)") +
  scale_x_continuous(limits = c(log(0.5), 20), expand = c(0, 0)) +
  facet_grid(. ~ gsub(" ", "\n", species))

# # PDF -- facet by life_stage & season
# ggplot(density_mat_all, aes(x = density,
#                             y = pdf_median,
#                             color = taxon_capture, 
#                             fill = taxon_capture)) +
#   geom_ribbon(aes(ymin = pdf_lower,
#                   ymax = pdf_upper), 
#               alpha = 0.15,
#               color = NA) +
#   geom_line() +
#   theme_minimal() +
#   ggtitle("Modeled PDF of Bd-positive load") +
#   labs(color = "Species",
#        fill = "Species") +
#   xlab("log(Bd load) [-]") +
#   ylab("Median probability density [-]\n(with 25th to 75th percentiles)") +
#   scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0)) +
#   facet_grid(life_stage_simple ~ season)
```

### Moded Bd load CCDF
```{r}
#| echo: false
#| warning: false
#| fig-height: 8
#| fig-width: 8
# CCDF -- facet by species
ggplot(density_mat_all, aes(x = density,
                            y = ccdf_median,
                            color = life_stage_simple, 
                            fill = life_stage_simple)) +
  geom_ribbon(aes(ymin = ccdf_lower,
                  ymax = ccdf_upper), 
              alpha = 0.15,
              color = NA) +
  geom_line() +
  theme_minimal() +
  ggtitle("Modeled CCDF of Bd-positive load") +
  labs(color = "Life stage",
       fill = "Life stage") +
  xlab("log(Bd load) [-]") +
  ylab("Median complementary cumulative density (1 - CDF) [-]\n(with 25th to 75th percentiles)") +
  scale_x_continuous(limits = c(log(0.5), 12), expand = c(0, 0)) +
  ylim(0, 0.75) +
  # facet_grid(. ~ gsub(" ", "\n", species))
  facet_wrap("species")

# CCDF -- facet by life_stage & season
# ggplot(density_mat_all, aes(x = density,
#                             y = ccdf_median,
#                             color = taxon_capture,
#                             fill = taxon_capture)) +
#   geom_ribbon(aes(ymin = ccdf_lower,
#                   ymax = ccdf_upper),
#               alpha = 0.15,
#               color = NA) +
#   geom_line() +
#   theme_minimal() +
#   ggtitle("Modeled CCDF of Bd-positive load") +
#   labs(color = "Species",
#        fill = "Species") +
#   xlab("log(Bd load) [-]") +
#   ylab("Median complementary cumulative density (1 - CDF) [-]\n(with 25th to 75th percentiles)") +
#   scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0)) +
#   ylim(0, 1) +
#   facet_grid(. ~ life_stage_simple)
```

# Environmental conditions

## Distributions
```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Environmental conditions distributions code"
#| fig-height: 6
#| fig-width: 8

# 15-day
# ggplot(brms_data, aes(x = temp_c_15_day_mean, y = precip_mm_15_day_sum, color = life_stage_simple)) +
#   geom_point(alpha = 0.1) +
#   stat_ellipse() +
#   facet_wrap(. ~ taxon_capture) +
#   xlim(-5, 40) +
#   ylim(0, 200) +
#   labs(x = "15-day temperature mean (degC)", 
#        y = "15-day precipitation total (mm)",
#        title = "Temperature v. precipitation") +
#   theme_minimal()

# 30-day by species
ggplot(brms_data, aes(x = temp_c_30_day_mean, y = precip_mm_30_day_sum, color = life_stage_simple)) +
  geom_point(alpha = 0.1) +
  stat_ellipse() +
  facet_wrap(. ~ taxon_capture) +
  xlim(-5, 40) +
  ylim(0, 400) +
  labs(x = "30-day temperature mean (degC)", 
       y = "30-day precipitation total (mm)",
       title = "Temperature v. precipitation") +
  theme_minimal()

# 30 day collective
ggplot(brms_data, aes(x = temp_c_30_day_mean, y = precip_mm_30_day_sum, color = taxon_capture)) +
  geom_point(alpha = 0.1) +
  stat_ellipse() +
  labs(x = "30-day temperature mean (degC)", 
       y = "30-day precipitation total (mm)",
       title = "Temperature v. precipitation") +
  theme_minimal()

# 30 day collective, scaled to climate by species
ggplot(brms_data, aes(x = temp_c_30_sp_z, y = precip_mm_30_sp_z, color = taxon_capture)) +
  geom_point(alpha = 0.1) +
  stat_ellipse() +
  labs(x = "30-day temperature mean (degC)", 
       y = "30-day precipitation total (mm)",
       title = "Temperature v. precipitation") +
  theme_minimal()


# ggplot(brms_data, aes(x = temp_c_30_sp_z2, y = precip_mm_30_sp_z2, color = life_stage_simple)) +
#   geom_point(alpha = 0.1) +
#   stat_ellipse() +
#   facet_wrap(. ~ taxon_capture) +
#   labs(x = "30-day temperature mean (degC)", 
#        y = "30-day precipitation total (mm)",
#        title = "Temperature v. precipitation") +
#   theme_minimal()
```

## Tempurature effects
```{r}
#| eval: true
#| code-fold: true
#| code-summary: "Show temperature effects code"
#| fig-height: 6
#| fig-width: 8

select_model = m5f_zln
# select_model = m6_zln

climate_draws = spread_draws(select_model, `b_temp_c.*|b_precip_mm.*|b_hu_temp_c.*|b_hu_precip_mm.*|b_Intercept|b_hu_Intercept`, regex = TRUE)

# Temperature dependence
temp_range = seq(-5, 45, length.out = 100)

temp_grid = expand_grid(temp_c_15_day_mean = temp_range, .draw = 1:nrow(climate_draws)) %>%
  mutate(temp_c_30_day_mean = temp_c_15_day_mean) %>%
  left_join(climate_draws, by = ".draw") %>%
  mutate(
    temp_c_15_z = (temp_c_15_day_mean - brms_scales$temp_c_15_day_mean_mean) / brms_scales$temp_c_15_day_mean_sd,
    temp_c_15_z2 = (temp_c_15_day_mean^2 - brms_scales$temp_c_15_day_mean2_mean) / brms_scales$temp_c_15_day_mean2_sd,
    temp_c_30_z = (temp_c_30_day_mean - brms_scales$temp_c_30_day_mean_mean) / brms_scales$temp_c_30_day_mean_sd,
    temp_c_30_z2 = (temp_c_30_day_mean^2 - brms_scales$temp_c_30_day_mean2_mean) / brms_scales$temp_c_30_day_mean2_sd,
    b_pred = b_temp_c_30_z * temp_c_30_z + b_temp_c_30_z2 * temp_c_30_z2 + b_Intercept,
    hu_pred = b_hu_temp_c_15_z * temp_c_15_z + b_hu_temp_c_15_z2 * temp_c_15_z2 + b_hu_Intercept
  ) %>%
  group_by(temp_c_15_day_mean) %>%
  summarise(
    b_mean = mean(b_pred),
    b_med = median(b_pred),
    b_lower_95 = quantile(b_pred, 0.025),
    b_upper_95 = quantile(b_pred, 0.975),
    b_lower_89 = quantile(b_pred, 0.055),
    b_upper_89 = quantile(b_pred, 0.945),
    hu_mean = mean(hu_pred),
    hu_med = median(hu_pred),
    hu_lower_95 = quantile(hu_pred, 0.025),
    hu_upper_95 = quantile(hu_pred, 0.975),
    hu_lower_89 = quantile(hu_pred, 0.055),
    hu_upper_89 = quantile(hu_pred, 0.945),
    p_mean = plogis(mean(hu_pred)),
    p_med = plogis(median(hu_pred)),
    p_lower_95 = plogis(quantile(hu_pred, 0.025)),
    p_upper_95 = plogis(quantile(hu_pred, 0.975)),
    p_lower_89 = plogis(quantile(hu_pred, 0.055)),
    p_upper_89 = plogis(quantile(hu_pred, 0.945)),
    .groups = "drop"
  ) %>%
  rename(temp_c = temp_c_15_day_mean)

# prevalence
ggplot(temp_grid, aes(x = temp_c)) +
  geom_ribbon(aes(ymin = p_lower_89, ymax = p_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = p_lower_95, ymax = p_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = p_mean), linewidth = 1) +
  labs(x = "15-day mean temperature (degC)", 
       y = "Probability of Bd detection",
       title = "Bd prevalence v. temperature") +
  theme_minimal()

# load
ggplot(temp_grid, aes(x = temp_c)) +
  geom_ribbon(aes(ymin = b_lower_89, ymax = b_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = b_lower_95, ymax = b_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = b_mean), linewidth = 1) +
  labs(x = "30-day mean temperature (degC)", 
       y = "log(+ Bd load)",
       title = "Bd load v. temperature") +
  theme_minimal()
```

## Precipitation effects
```{r}
#| eval: true
#| code-fold: true
#| code-summary: "Show precipitation effects code"
#| fig-height: 6
#| fig-width: 8
# precipitation depencence

daily_precip_range = seq(0, 20, length.out = 100)

precip_grid = expand_grid(daily_precip = daily_precip_range, .draw = 1:nrow(climate_draws)) %>%
  mutate(precip_mm_15_day_sum = daily_precip * 15,
         precip_mm_30_day_sum = daily_precip * 30) %>%
  left_join(climate_draws, by = ".draw") %>%
  mutate(
    precip_mm_15_z = (precip_mm_15_day_sum - brms_scales$precip_mm_15_day_sum_mean) / brms_scales$precip_mm_15_day_sum_sd,
    precip_mm_15_z2 = (precip_mm_15_day_sum^2 - brms_scales$precip_mm_15_day_sum2_mean) / brms_scales$precip_mm_15_day_sum2_sd,
    precip_mm_30_z = (precip_mm_30_day_sum - brms_scales$precip_mm_30_day_sum_mean) / brms_scales$precip_mm_30_day_sum_sd,
    precip_mm_30_z2 = (precip_mm_30_day_sum^2 - brms_scales$precip_mm_30_day_sum2_mean) / brms_scales$precip_mm_30_day_sum2_sd,
    b_pred = b_precip_mm_30_z * precip_mm_30_z + b_precip_mm_30_z2 * precip_mm_30_z2 + b_Intercept,
    hu_pred = b_hu_precip_mm_15_z * precip_mm_15_z + b_hu_precip_mm_15_z2 * precip_mm_15_z2 + b_hu_Intercept
  ) %>%
  group_by(daily_precip,
           precip_mm_15_day_sum,
           precip_mm_30_day_sum) %>%
  summarise(
    b_mean = mean(b_pred),
    b_med = median(b_pred),
    b_lower_95 = quantile(b_pred, 0.025),
    b_upper_95 = quantile(b_pred, 0.975),
    b_lower_89 = quantile(b_pred, 0.055),
    b_upper_89 = quantile(b_pred, 0.945),
    hu_mean = mean(hu_pred),
    hu_med = median(hu_pred),
    hu_lower_95 = quantile(hu_pred, 0.025),
    hu_upper_95 = quantile(hu_pred, 0.975),
    hu_lower_89 = quantile(hu_pred, 0.055),
    hu_upper_89 = quantile(hu_pred, 0.945),
    p_mean = plogis(mean(hu_pred)),
    p_med = plogis(median(hu_pred)),
    p_lower_95 = plogis(quantile(hu_pred, 0.025)),
    p_upper_95 = plogis(quantile(hu_pred, 0.975)),
    p_lower_89 = plogis(quantile(hu_pred, 0.055)),
    p_upper_89 = plogis(quantile(hu_pred, 0.945)),
    .groups = "drop"
  )

# prevalence
ggplot(precip_grid, aes(x = precip_mm_15_day_sum)) +
  geom_ribbon(aes(ymin = p_lower_89, ymax = p_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = p_lower_95, ymax = p_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = p_mean), linewidth = 1) +
  labs(x = "15-day total precipitation (mm)", 
       y = "Probability of Bd detection",
       title = "Bd prevalence v. precipitation") +
  theme_minimal()

# load
ggplot(precip_grid, aes(x = precip_mm_30_day_sum)) +
  geom_ribbon(aes(ymin = b_lower_89, ymax = b_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = b_lower_95, ymax = b_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = b_mean), linewidth = 1) +
  labs(x = "30-day total precipitation (mm)", 
       y = "log(+ Bd load)",
       title = "Bd load v. precipitation") +
  theme_minimal()

```

## Tempurature effects (scaled by species climate)
```{r}
#| eval: true
#| code-fold: true
#| code-summary: "Show temperature effects code"
#| fig-height: 6
#| fig-width: 8


select_model = m6_zln

# fixed effects
climate_draws = spread_draws(select_model, `b_temp_c.*|b_precip_mm.*|b_hu_temp_c.*|b_hu_precip_mm.*|b_Intercept|b_hu_Intercept`, regex = TRUE)

# Temperature dependence
temp_range = seq(-3, 3, length.out = 100)

# taxa = brms_data %>%
#   select(taxon_capture) %>%
#   distinct() %>%
#   pull(taxon_capture) %>%
#   sort()

## Stumped by how to back-calculate the temp_z2 values from the temp_z values... I think this has to be done on a species-by-species basis...

temp_grid = expand_grid(temp_z_15_mean = temp_range,
                        .draw = 1:nrow(climate_draws)) %>%
  mutate(temp_z_30_mean = temp_z_15_mean) %>%
  left_join(climate_draws, by = ".draw") %>%
  mutate(
    temp_c_15_z = (temp_c_15_day_mean - brms_scales$temp_c_15_day_mean_mean) / brms_scales$temp_c_15_day_mean_sd,
    temp_c_15_z2 = (temp_c_15_day_mean^2 - brms_scales$temp_c_15_day_mean2_mean) / brms_scales$temp_c_15_day_mean2_sd,
    temp_c_30_z = (temp_c_30_day_mean - brms_scales$temp_c_30_day_mean_mean) / brms_scales$temp_c_30_day_mean_sd,
    temp_c_30_z2 = (temp_c_30_day_mean^2 - brms_scales$temp_c_30_day_mean2_mean) / brms_scales$temp_c_30_day_mean2_sd,
    b_pred = b_temp_c_30_sp_z * temp_c_30_z + b_temp_c_30_sp_z2 * temp_c_30_z2 + b_Intercept,
    hu_pred = b_hu_temp_c_15_sp_z * temp_c_15_z + b_hu_temp_c_15_sp_z2 * temp_c_15_z2 + b_hu_Intercept
  ) %>%
  group_by(temp_c_15_day_mean) %>%
  summarise(
    b_mean = mean(b_pred),
    b_med = median(b_pred),
    b_lower_95 = quantile(b_pred, 0.025),
    b_upper_95 = quantile(b_pred, 0.975),
    b_lower_89 = quantile(b_pred, 0.055),
    b_upper_89 = quantile(b_pred, 0.945),
    hu_mean = mean(hu_pred),
    hu_med = median(hu_pred),
    hu_lower_95 = quantile(hu_pred, 0.025),
    hu_upper_95 = quantile(hu_pred, 0.975),
    hu_lower_89 = quantile(hu_pred, 0.055),
    hu_upper_89 = quantile(hu_pred, 0.945),
    p_mean = plogis(mean(hu_pred)),
    p_med = plogis(median(hu_pred)),
    p_lower_95 = plogis(quantile(hu_pred, 0.025)),
    p_upper_95 = plogis(quantile(hu_pred, 0.975)),
    p_lower_89 = plogis(quantile(hu_pred, 0.055)),
    p_upper_89 = plogis(quantile(hu_pred, 0.945)),
    .groups = "drop"
  ) %>%
  rename(temp_c = temp_c_15_day_mean)

# prevalence
ggplot(temp_grid, aes(x = temp_c)) +
  geom_ribbon(aes(ymin = p_lower_89, ymax = p_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = p_lower_95, ymax = p_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = p_mean), linewidth = 1) +
  labs(x = "15-day mean temperature (degC)", 
       y = "Probability of Bd detection",
       title = "Bd prevalence v. temperature") +
  theme_minimal()

# load
ggplot(temp_grid, aes(x = temp_c)) +
  geom_ribbon(aes(ymin = b_lower_89, ymax = b_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = b_lower_95, ymax = b_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = b_mean), linewidth = 1) +
  labs(x = "30-day mean temperature (degC)", 
       y = "log(+ Bd load)",
       title = "Bd load v. temperature") +
  theme_minimal()
```

## Precipitation effects (scaled by species climate)
```{r}
#| eval: true
#| code-fold: true
#| code-summary: "Show precipitation effects code"
#| fig-height: 6
#| fig-width: 8
# precipitation depencence

daily_precip_range = seq(0, 20, length.out = 100)

precip_grid = expand_grid(daily_precip = daily_precip_range, .draw = 1:nrow(climate_draws)) %>%
  mutate(precip_mm_15_day_sum = daily_precip * 15,
         precip_mm_30_day_sum = daily_precip * 30) %>%
  left_join(climate_draws, by = ".draw") %>%
  mutate(
    precip_mm_15_z = (precip_mm_15_day_sum - brms_scales$precip_mm_15_day_sum_mean) / brms_scales$precip_mm_15_day_sum_sd,
    precip_mm_15_z2 = (precip_mm_15_day_sum^2 - brms_scales$precip_mm_15_day_sum2_mean) / brms_scales$precip_mm_15_day_sum2_sd,
    precip_mm_30_z = (precip_mm_30_day_sum - brms_scales$precip_mm_30_day_sum_mean) / brms_scales$precip_mm_30_day_sum_sd,
    precip_mm_30_z2 = (precip_mm_30_day_sum^2 - brms_scales$precip_mm_30_day_sum2_mean) / brms_scales$precip_mm_30_day_sum2_sd,
    b_pred = b_precip_mm_30_z * precip_mm_30_z + b_precip_mm_30_z2 * precip_mm_30_z2 + b_Intercept,
    hu_pred = b_hu_precip_mm_15_z * precip_mm_15_z + b_hu_precip_mm_15_z2 * precip_mm_15_z2 + b_hu_Intercept
  ) %>%
  group_by(daily_precip,
           precip_mm_15_day_sum,
           precip_mm_30_day_sum) %>%
  summarise(
    b_mean = mean(b_pred),
    b_med = median(b_pred),
    b_lower_95 = quantile(b_pred, 0.025),
    b_upper_95 = quantile(b_pred, 0.975),
    b_lower_89 = quantile(b_pred, 0.055),
    b_upper_89 = quantile(b_pred, 0.945),
    hu_mean = mean(hu_pred),
    hu_med = median(hu_pred),
    hu_lower_95 = quantile(hu_pred, 0.025),
    hu_upper_95 = quantile(hu_pred, 0.975),
    hu_lower_89 = quantile(hu_pred, 0.055),
    hu_upper_89 = quantile(hu_pred, 0.945),
    p_mean = plogis(mean(hu_pred)),
    p_med = plogis(median(hu_pred)),
    p_lower_95 = plogis(quantile(hu_pred, 0.025)),
    p_upper_95 = plogis(quantile(hu_pred, 0.975)),
    p_lower_89 = plogis(quantile(hu_pred, 0.055)),
    p_upper_89 = plogis(quantile(hu_pred, 0.945)),
    .groups = "drop"
  )

# prevalence
ggplot(precip_grid, aes(x = precip_mm_15_day_sum)) +
  geom_ribbon(aes(ymin = p_lower_89, ymax = p_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = p_lower_95, ymax = p_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = p_mean), linewidth = 1) +
  labs(x = "15-day total precipitation (mm)", 
       y = "Probability of Bd detection",
       title = "Bd prevalence v. precipitation") +
  theme_minimal()

# load
ggplot(precip_grid, aes(x = precip_mm_30_day_sum)) +
  geom_ribbon(aes(ymin = b_lower_89, ymax = b_upper_89), 
              fill = "steelblue", alpha = 0.3) +
  geom_ribbon(aes(ymin = b_lower_95, ymax = b_upper_95), 
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = b_mean), linewidth = 1) +
  labs(x = "30-day total precipitation (mm)", 
       y = "log(+ Bd load)",
       title = "Bd load v. precipitation") +
  theme_minimal()

```