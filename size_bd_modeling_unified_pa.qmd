---
title: "Size vs. Bd modeling: Panamá preliminary results"
author: Cob Staines
date: 2025-09-29
format:
  html:
    toc: true
df-print: kable
bibliography: references.bib
csl: ecology.csl
---
# Introduction

## Motivation

Patterns of greater Bd load in recently metamorphosed individuals have been documented in some cases[@adams_chytridiomycosis-induced_2020] [@humphries_immune_2022] [@humphries_chytridiomycosis_2024] [@humphries_chytridiomycosis_2025] (and the opposite pattern in others[@bradley_host_2019]), with possible implications for:

  - population dynamics (Q2)
  - assessing Bd resistance/tolerance mechanisms (Q3)
  - resilience trajectory assessment (Q1)

... with the goal of complementing ongoing RIBBiTR research efforts

## Working hypotheses:

  a. Younger, more-recently-metamorphosed individuals are more susceptible to infection with Bd than older individuals across species
  b. Younger, more-recently-metamorphosed individuals are more likely to carry higher Bd loads than older individuals across species

# Methods
## Setup

```{r}
#| eval: true
#| output: false
#| code-fold: true
#| code-summary: "Show setup code"

# setup
librarian::shelf(tidyverse, dbplyr, here, janitor, RPostgres, DBI, RIBBiTR-BII/ribbitrrr, brms, tidybayes, ggplot2)

## Connect to DB
dbcon = hopToDB("ribbitr", hopReg = FALSE)

# table pointers
db_bd = tbl(dbcon, Id("survey_data", "bd_qpcr_results"))
db_sample = tbl(dbcon, Id("survey_data", "sample"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_visit = tbl(dbcon, Id("survey_data", "visit"))
db_site = tbl(dbcon, Id("survey_data", "site"))
db_region = tbl(dbcon, Id("survey_data", "region"))
db_country = tbl(dbcon, Id("survey_data", "country"))

db_temp = tbl(dbcon, Id("microclimate_data", "ts_temperature"))
db_rh = tbl(dbcon, Id("microclimate_data", "ts_relative_humidity"))
db_sensor = tbl(dbcon, Id("microclimate_data", "sensor"))
db_logger = tbl(dbcon, Id("microclimate_data", "logger"))

bd_sample = db_sample %>%
  right_join(db_capture, by = "capture_id") %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by = "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  filter(sample_type == "bd")
```
## Data selection
### Classifying by life stage
These analysis were carried out for post-metamorphic individuals only. Individuals were classified as "adult" or "subadult" with a threshold snout-vent-length (SVL [mm]), identified independently for each species from the literature (see data collection code for specific thresholds used and their sources).

<!-- ### Classification by season -->
<!-- The data were also classified into two seasons: -->

<!--   - **Lluvia (wet)**: May - August -->
<!--   - **Seca (dry)**: October - January -->
  
### Classification by population
"Populations" were defined at the region level within Panamá.
  
### Species selection criteria:
Species were were included for if at least 14 adult AND subadult each were present for that species.


```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Show data collection code"

population_valid = c("altos_de_campana",
                     "caribbean",
                     "el_cope",
                     "el_valle",
                     "santa_fe")

# define life_stage_simple by SVL
bd_population = bd_sample %>%
  mutate(population = region,
         tax_pop = paste0(taxon_capture, "_", population),
         year = year(date),
         life_stage_simple = case_when(
           # Savage 1972 & Crump 1988
           ((taxon_capture == "atelopus_varius") & (svl_mm >= 25)) ~ "adult",
           ((taxon_capture == "atelopus_varius") & (svl_mm < 25)) ~ "subadult",
           # Lynch and Myers 1983
           ((taxon_capture == "craugastor_crassidigitus") & (svl_mm >= 20.2)) ~ "adult",
           ((taxon_capture == "craugastor_crassidigitus") & (svl_mm < 20.2)) ~ "subadult",
           # Lynch and Myers 1983
           ((taxon_capture == "craugastor_fitzingeri") & (svl_mm >= 23.5)) ~ "adult",
           ((taxon_capture == "craugastor_fitzingeri") & (svl_mm < 23.5)) ~ "subadult",
           # Amphibiaweb
           ((taxon_capture == "colostethus_panamansis") & (svl_mm >= 18.8)) ~ "adult",
           ((taxon_capture == "colostethus_panamansis") & (svl_mm < 18.8)) ~ "subadult",
           # Leenders 2001
           ((taxon_capture == "dendrobates_auratus") & (svl_mm >= 25)) ~ "adult",
           ((taxon_capture == "dendrobates_auratus") & (svl_mm < 25)) ~ "subadult",
           # Amphibiaweb
           ((taxon_capture == "espadarana_prosoblepon") & (svl_mm >= 21)) ~ "adult",
           ((taxon_capture == "espadarana_prosoblepon") & (svl_mm < 21)) ~ "subadult",
           # Basante 2025
           ((taxon_capture == "lithobates_warszewitschii") & (svl_mm >= 35)) ~ "adult",
           ((taxon_capture == "lithobates_warszewitschii") & (svl_mm < 35)) ~ "subadult",
           # Wang 2008
           ((taxon_capture == "pristimantis_ridens") & (svl_mm >= 16)) ~ "adult",
           ((taxon_capture == "pristimantis_ridens") & (svl_mm < 16)) ~ "subadult",
           # Savage 2002
           ((taxon_capture == "rhaebo_haematiticus") & (svl_mm >= 42)) ~ "adult",
           ((taxon_capture == "rhaebo_haematiticus") & (svl_mm < 42)) ~ "subadult",
           # Easteal 1963
           ((taxon_capture == "rhinella_marina") & (svl_mm >= 85)) ~ "adult",
           ((taxon_capture == "rhinella_marina") & (svl_mm < 85)) ~ "subadult",
           # Savage 2002
           ((taxon_capture == "sachatamia_albomaculata") & (svl_mm >= 20.5)) ~ "adult",
           ((taxon_capture == "sachatamia_albomaculata") & (svl_mm < 20.5)) ~ "subadult",
           # Ibunez & Smith 1995
           ((taxon_capture == "silverstoneia_flotator") & (svl_mm >= 15.1)) ~ "adult",
           ((taxon_capture == "silverstoneia_flotator") & (svl_mm < 15.1)) ~ "subadult",
           # Grant & Myers 2013
           ((taxon_capture == "silverstoneia_nubicola") & (svl_mm >= 15.4)) ~ "adult",
           ((taxon_capture == "silverstoneia_nubicola") & (svl_mm < 15.4)) ~ "subadult",
           # Duellman, W. E. 2001
           ((taxon_capture == "smilisca_sila") & (svl_mm >= 31.6)) ~ "adult",
           ((taxon_capture == "smilisca_sila") & (svl_mm < 31.6)) ~ "subadult",
           .default = NA_character_
         )) %>%
  filter(country == "panama",
         population %in% population_valid,
         !(life_stage %in% c("eggmass", "tadpole")),
         !is.na(svl_mm))

# identify valid species & seasons
bd_species_valid = bd_population %>%
  mutate(month = month(date),
         season = case_match(month,
                             c(5, 6, 7, 8) ~ "lluvia",
                             c(10, 11, 12, 1) ~ "seca",
                             .default = NA_character_)) %>%
  filter(!is.na(taxon_capture),
         !is.na(season),
         !is.na(life_stage_simple)) %>%
  group_by(taxon_capture, life_stage_simple) %>%
  summarise(count = n(),
            count_gte_14 = n() >= 14,
            .groups = "drop") %>%
  group_by(taxon_capture) %>%
  filter(sum(as.integer(count_gte_14)) == 2) %>%
  ungroup() %>%
  collect()

# identify valid samples
bd_sample_valid = bd_population %>%
  mutate(month = month(date),
         season = case_match(month,
                             c(5, 6, 7, 8) ~ "lluvia",
                             c(10, 11, 12, 1) ~ "seca",
                             .default = NA_character_)) %>%
  inner_join(bd_species_valid %>%
               select("taxon_capture",
                      "life_stage_simple"), by = c("taxon_capture", "life_stage_simple"), copy = TRUE) %>%
  inner_join(db_bd %>%
              filter(!is.na(detected)) %>%
              group_by(sample_id) %>%
              slice_sample(n = 1) %>%
              ungroup() %>%
              select(sample_id,
                     detected,
                     bd_its1_copies_per_swab),
            by = "sample_id") %>%
  select(sample_id,
         detected,
         bd_its1_copies_per_swab,
         sample_name,
         capture_id,
         taxon_capture,
         life_stage,
         life_stage_simple,
         svl_mm,
         body_mass_g,
         sex,
         survey_id,
         start_timestamp_utc,
         date,
         season,
         site,
         site_id,
         geographic_area,
         population,
         tax_pop,
         region,
         country) %>%
  collect()

site_valid = bd_sample_valid %>%
  select(site_id) %>%
  distinct() %>%
  pull(site_id)

site_date_valid = bd_sample_valid %>%
  group_by(site,
           site_id,
           region,
           date) %>%
  summarise(swabs_n = n(),
            .groups = "drop") %>%
  collect()

# temp_valid = db_temp %>%
#   left_join(db_sensor, by = "sensor_id") %>%
#   left_join(db_logger, by = "logger_id") %>%
#   left_join(db_site, by = "site_id") %>%
#   filter(site_id %in% site_valid) %>%
#   mutate(date = date(timestamp_utc)) %>%
#   select(site_id,
#          date) %>%
#   distinct() %>%
#   mutate(temp = TRUE) %>%
#   collect()
# 
# rh_valid = db_rh %>%
#   left_join(db_sensor, by = "sensor_id") %>%
#   left_join(db_logger, by = "logger_id") %>%
#   left_join(db_site, by = "site_id") %>%
#   filter(site_id %in% site_valid) %>%
#   mutate(date = date(timestamp_utc)) %>%
#   select(site_id,
#          date) %>%
#   distinct() %>%
#   mutate(rh = TRUE) %>%
#   collect()
# 
# microclimate_valid = site_date_valid %>%
#   left_join(temp_valid, by = c("site_id", "date")) %>%
#   left_join(rh_valid, by = c("site_id", "date")) %>%
#   mutate(temp = if_else(is.na(temp), FALSE, temp),
#          rh = if_else(is.na(rh), FALSE, rh)) %>%
#   group_by(region) %>%
#   summarise(n_days = n(),
#             temp_days_ratio = sum(temp) / n(),
#             rh_days_ratio = sum(temp) / n(),
#             n_swabs = sum(swabs_n),
#             temp_swabs_ratio = sum(swabs_n[temp]) / sum(swabs_n),
#             rh_swabs_ratio = sum(swabs_n[rh]) / sum(swabs_n),
#             .groups = "drop") %>%
#   arrange(region)

# final data selection and cleaning for model
bd_model = bd_sample_valid %>%
  filter(!is.na(bd_its1_copies_per_swab),
         !is.na(svl_mm)) %>%
  rename(bd_load = bd_its1_copies_per_swab,
         bd_detected = detected) %>%
  mutate(bd_detected_co = bd_load >= 10,
         bd_load_co = if_else(bd_load < 10,
                                  0,
                                  bd_load),
         bd_load_co_density = bd_load_co / svl_mm,
         log_bd_load_co_density = log(bd_load_co_density),
         log_bd_load_co = log(bd_load_co)) %>%
  select(bd_load_co,
         log_bd_load_co,
         bd_load_co_density,
         log_bd_load_co_density,
         bd_detected_co,
         svl_mm,
         site,
         population,
         taxon_capture,
         tax_pop,
         life_stage,
         life_stage_simple,
         date,
         season,
         population,
         region,
         country)

head(bd_model)
```

# environmental data
```{r}
sliding_window <- function(df, ts_col_name, window_size, f, result_col_name) {
  ts_sym <- sym(ts_col_name)
  res_sym <- sym(result_col_name)
  
  df %>%
    group_modify(~{
      n <- nrow(.x)
      ts_vals <- pull(.x, !!ts_sym)
      agg_vals <- map_dbl(seq_len(n), function(i) {
        if (i >= window_size) {
          window_vals <- ts_vals[(i - window_size + 1):i]
          f(window_vals)
        } else {
          NA_real_
        }
      })
      .x[[result_col_name]] <- agg_vals
      .x
    })
}

n_val = function(x) sum(!is.na(x))

na_mean = function(x) {
  if (all(is.na(x)))
    return(NA)
  else {
    return(mean(x, na.rm = TRUE))
  }
}

na_max = function(x) {
  if (all(is.na(x)))
    return(NA)
  else {
    return(max(x, na.rm = TRUE))
  }
}

ts_in = read_csv(here("python", "gee_env_pull", "data", "gee_chirps_modis_data_025.csv"))

env_agg = ts_in %>%
  arrange(site, date) %>%
  group_by(site) %>%
  sliding_window("precipitation_mm", 365, sum, "precip_mm_year_sum") %>%
  sliding_window("temperature_c", 365, na_mean, "temp_c_year_mean") %>%
  sliding_window("precipitation_mm", 15, n_val, "precip_mm_15_day_n") %>%
  sliding_window("precipitation_mm", 15, sum, "precip_mm_15_day_sum") %>%
    sliding_window("precipitation_mm", 30, n_val, "precip_mm_30_day_n") %>%
  sliding_window("precipitation_mm", 30, sum, "precip_mm_30_day_sum") %>%
  sliding_window("temperature_c", 15, n_val, "temp_c_15_day_n") %>%
  sliding_window("temperature_c", 15, na_mean, "temp_c_15_day_mean") %>%
  sliding_window("temperature_c", 15, na_max, "temp_c_15_day_max") %>%
    sliding_window("temperature_c", 30, n_val, "temp_c_30_day_n") %>%
  sliding_window("temperature_c", 30, na_mean, "temp_c_30_day_mean") %>%
  sliding_window("temperature_c", 30, na_max, "temp_c_30_day_max") %>%
  ungroup()

# ggplot(env_agg, aes(x = date)) +
#   geom_line(aes(y = precip_mm_15_day_sum), linetype = "solid") +
#   facet_wrap(. ~ site)
# 
# ggplot(env_agg, aes(x = date, y = temp_c_year_mean, color = site)) +
#   geom_line()


bd_model_env = bd_model %>%
  left_join(env_agg, by = c("site", "date"))


```

## Descriptive stats of data
```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Show selected data stats code"

(bd_model_stats = bd_model %>%
  group_by(taxon_capture, country, season) %>%
  summarise(regions = paste(sort(unique(region)), collapse = ", "),
            population_n = n_distinct(population),
            site_n = n_distinct(site),
            year_first = year(min(date)),
            year_last = year(max(date)),
            year_count = n_distinct(year(date)),
            adult_n = sum(life_stage_simple == "adult"),
            subadult_n = sum(life_stage_simple == "subadult"),
            .groups = "drop") %>%
  arrange(country,
          taxon_capture))

year_stats = bd_model %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(samples_n = n(),
            .groups = "drop")

bd_pop_stats = bd_model %>%
  group_by(population) %>%
  summarize(taxa_n = n_distinct(taxon_capture),
            samples_n = n(),
            adult_n = sum(life_stage_simple == "adult"),
            subadult_n = sum(life_stage_simple == "subadult"),
            .groups = "drop")

# export site list and coords
buffer = 0.025
site_lookup = bd_model %>%
  select(site) %>%
  distinct() %>%
  left_join(db_site %>%
              collect(), by = "site") %>%
  select(site_id,
         site,
         site_latitude,
         site_longitude) %>%
  mutate(N = site_latitude + buffer,
         S = site_latitude - buffer,
         W = site_longitude - buffer,
         E = site_longitude + buffer) %>%
  write_csv(here("python", "gee_env_pull", "data", "site_coords_panama_025.csv"))

```

## Modeling
I modeled Bd load using a Baysian zero-inflated (or "hurdle") log-normal model [@schrock2025fungi] with fixed effects of life stage and season, and considering population as a random effect. The "hurdle" infection probability (hu) and the variability in Bd load (sigma) are allowed to vary with life stage and season (where multiple seasons are available) as well. Each species was modeled independently.

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Show model code"

# unified model

brms_data <- bd_model_env %>%
  mutate(
    precip_mm_30_z  = as.numeric(scale(precip_mm_30_day_sum,  center = TRUE, scale = TRUE)),
    temp_c_30_z     = as.numeric(scale(temp_c_30_day_mean,    center = TRUE, scale = TRUE)),
    precip_mm_15_z  = as.numeric(scale(precip_mm_15_day_sum,  center = TRUE, scale = TRUE)),
    temp_c_15_z     = as.numeric(scale(temp_c_15_day_mean,    center = TRUE, scale = TRUE))
  ) %>%
  # squared terms (on the z-scored variables)
  mutate(
    precip_mm_30_z2 = precip_mm_30_z^2,
    temp_c_30_z2    = temp_c_30_z^2,
    precip_mm_15_z2 = precip_mm_15_z^2,
    temp_c_15_z2    = temp_c_15_z^2
  )


m3_ltp <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture + (1 | population / site),
    hu ~ 1 + life_stage_simple * taxon_capture + (1 | population / site),
    sigma ~ 1 + life_stage_simple * taxon_capture
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  chains = 4,
  iter = 4000,
  warmup = 1000,
  cores = 4,
  control = list(adapt_delta = 0.98, max_treedepth = 12),
  seed = 124,
  save_pars = save_pars(all = TRUE)
)
saveRDS(m3_ltp, file = "model_results_zln_life_tax_pop_unified.rds")
m3_ltp = readRDS(file = "model_results_zln_life_tax_pop_unified.rds")


m4_hln <- brm(
  formula = bf(
    bd_load_co_density ~ 1 + life_stage_simple * taxon_capture +
      precip_mm_30_z + temp_c_30_z,
    hu ~ 1 + life_stage_simple * taxon_capture +
      precip_mm_15_z + temp_c_15_z,
    sigma ~ 1 + life_stage_simple * taxon_capture
  ),
  data = brms_data,
  family = hurdle_lognormal(),
  chains = 4,
  iter = 4000,
  warmup = 1000,
  cores = 4,
  control = list(adapt_delta = 0.95, max_treedepth = 12),
  seed = 123,
  save_pars = save_pars(all = TRUE)
)

saveRDS(m4_hln, file = "model_results_zln_life_tax_env_unified.rds")
m4_hln = readRDS(file = "model_results_zln_life_tax_env_unified.rds")

summary(m4_hln)
model_report(m4_hln)

loo_m3 <- loo(m3_ltp, moment_match = TRUE, reloo = TRUE)
loo_m4 <- loo(m4_hln, moment_match = TRUE)
loo_comp <- loo_compare(list(site = loo_m3, env = loo_m4))

bayes_factor(m3_ltp, m4_hln)
```

## Processing and visualization
```{r}
#| eval: true
#| warning: false
#| code-fold: true
#| code-summary: "Show processing & visualization functions"

extract_abbr <- function(taxon) {
  parts <- strsplit(taxon, "_")[[1]]
  genus_abbr <- substr(parts[1], 1, 2)
  species_abbr <- substr(parts[2], 1, 2)
  paste0(genus_abbr, species_abbr)
}

load_model = function(taxon, template = "model_results_zln_life_tax_sea_pop_xxxx.rds"){
  filename = gsub("xxxx", extract_abbr(taxon), template)
  cat(taxon, ":\n\t", filename, "\n")
  return(readRDS(filename))
}

model_report = function(model_m){
  summary(model_m)
  plot((model_m), ask = FALSE)
  plot(conditional_effects(model_m), ask = FALSE)
  pp_check(model_m) +
    scale_x_log10()
}
get_species_name = function(taxon, newline = FALSE) {
  species_name = str_to_sentence(gsub("_", " ", taxon))
  if (newline) {
    species_name = gsub(" ", "\n", species_name)
  }
  return(species_name)
}

samp_pos = function(m_zln, lifestage, season, n, s = 1){
  pp = data.frame(
    life_stage_simple = lifestage,
    season = season,
    population = "NA"
  ) %>%
    slice(rep(1:n(), s))
  
  p_samp = posterior_predict(m_zln,
                             newdata = pp,
                             ndraws = n,
                             allow_new_levels = TRUE)
}

# draws
collect_draws = function(m_spec){
  model_vars = get_variables(m_spec)
  
  all_life_stage_simple = sort(unique(m_spec$data$life_stage_simple))
  all_taxon_capture = sort(unique(m_spec$data$taxon_capture))
  all_prefixes = c("b",
                   "b_hu",
                   "b_sigma")
  
  param_grid = crossing(prefix = all_prefixes,
                        life_stage_simple = all_life_stage_simple,
                        taxon_capture = all_taxon_capture) %>%
    mutate(param_name = paste0(prefix, "_", taxon_capture, "_", life_stage_simple),
           t_intercept = paste0(prefix, "_Intercept"),
           t_lss = if_else(life_stage_simple == all_life_stage_simple[1],
                               NA,
                               paste0(prefix, "_life_stage_simple", life_stage_simple)),
           t_tc = if_else(taxon_capture == all_taxon_capture[1],
                              NA,
                              paste0(prefix, "_taxon_capture", taxon_capture)),
           t_lss_tc = if_else(life_stage_simple == all_life_stage_simple[1] |
                                taxon_capture == all_taxon_capture[1],
                              NA,
                              paste0(prefix, "_life_stage_simple", life_stage_simple, "__", "taxon_capture", taxon_capture))) %>%
    unite(formula, t_intercept, t_lss, t_tc, t_lss_tc, sep = " + ", remove = FALSE, na.rm = TRUE) %>%
    mutate(expr = map(formula, ~ rlang::parse_expr(.x)))
  
  expr_list = set_names(param_grid$expr, param_grid$param_name)
  
  m_spread = m_spec %>%
    spread_draws(`b_.*`, regex = TRUE)
  colnames(m_spread) = gsub(":", "__", colnames(m_spread))
  
  m_spread_mutated = reduce(
    .x = names(expr_list),
    .init = m_spread,
    .f = function(df, param) {
      mutate(df,
             !!param := eval(expr_list[[param]], envir = df))
    }
  ) %>%
    select(.draw,
           all_of(param_grid$param_name)) %>%
    pivot_longer(cols = param_grid$param_name, names_to = "param_name") %>%
    left_join(param_grid %>%
                select(param_name, prefix, taxon_capture, life_stage_simple), by = "param_name") %>%
    pivot_wider(id_cols = c(.draw, taxon_capture, life_stage_simple),
                names_from = prefix) %>%
    left_join(m_spec %>%
                spread_draws(c(sd_population__Intercept,
                               sd_population__hu_Intercept)), by = ".draw") %>%
    mutate(p0 = plogis(b_hu),
           prevalence = 1 - p0,
           sigma = exp(b_sigma),
           sd_eff_bd_load = sqrt(sigma^2 + sd_population__Intercept^2)) %>%
    rename(sd_eff_hu = sd_population__hu_Intercept) %>%
    select(.draw,
           .chain,
           .iteration,
           everything())
  
  return(m_spread_mutated)
}

density_mat = function(lower, upper, len, draws){
  density_grid = seq(lower, upper, length.out = len)
  
  grouped_draws = draws %>%
    group_by(taxon_capture, life_stage_simple) %>%
    group_split()
  
  group_summaries = map(grouped_draws, function(group_df) {
    # Get the group labels
    life_stage = unique(group_df$life_stage_simple)
    taxon_capture = unique(group_df$taxon_capture)
    
    # Compute density matrices
    pdf_density_mat = pmap(
      list(group_df$b, group_df$sigma, group_df$p0),
      function(b, sigma, p0) {
        dnorm(density_grid, mean = b, sd = sigma) * (1 - p0)
      }
    ) %>%
      simplify2array() %>%
      t()
    
    ccdf_density_mat = pmap(
      list(group_df$b, group_df$sigma, group_df$p0),
      function(b, sigma, p0) {
        (1 - pnorm(density_grid, mean = b, sd = sigma)) * (1 - p0)
      }
    ) %>%
      simplify2array() %>%
      t()
    
    
    # Summary statistics:
    pdf_q.5 = apply(pdf_density_mat, 2, quantile, probs = 0.5)
    pdf_q.25 = apply(pdf_density_mat, 2, quantile, probs = 0.25)
    pdf_q.75 = apply(pdf_density_mat, 2, quantile, probs = 0.75)
    
    ccdf_q.5 = apply(ccdf_density_mat, 2, quantile, probs = 0.5)
    ccdf_q.25 = apply(ccdf_density_mat, 2, quantile, probs = 0.25)
    ccdf_q.75 = apply(ccdf_density_mat, 2, quantile, probs = 0.75)
    
    # Return a tidy tibble for plotting or analysis
    tibble(
      taxon_capture,
      life_stage_simple = life_stage,
      density = density_grid,
      pdf_median = pdf_q.5,
      pdf_lower = pdf_q.25,
      pdf_upper = pdf_q.75,
      ccdf_median = ccdf_q.5,
      ccdf_lower = ccdf_q.25,
      ccdf_upper = ccdf_q.75
    )
  })
  
  summary_df <- bind_rows(group_summaries)
}

samp_pos = function(m_zln, lifestage, season, n){

  pp = data.frame(
    life_stage_simple = lifestage,
    season = season,
    population = "NA"
  )
  
  p_samp = posterior_predict(m_zln,
                             newdata = pp,
                             ndraws = n,
                             allow_new_levels = TRUE)

}

sample_posterior_life_sea = function(m_zln, species_name, n = 10000){
  ps_adult_lluvia = samp_pos(m_zln, "adult", "lluvia", n)
  ps_adult_seca = samp_pos(m_zln, "adult", "seca", n)
  ps_subadult_lluvia = samp_pos(m_zln, "subadult", "lluvia", n)
  ps_subadult_seca = samp_pos(m_zln, "subadult", "seca", n)

  df_samps_adult_lluvia = data.frame(
    life_stage_simple = "adult",
    season = "lluvia",
    bd_load = ps_adult_lluvia
  )

  df_samps_adult_seca = data.frame(
    life_stage_simple = "adult",
    season = "seca",
    bd_load = ps_adult_seca
  )

  df_samps_subadult_lluvia = data.frame(
    life_stage_simple = "subadult",
    season = "lluvia",
    bd_load = ps_subadult_lluvia
  )
  
  df_samps_subadult_seca = data.frame(
    life_stage_simple = "subadult",
    season = "seca",
    bd_load = ps_subadult_seca
  )

  df_samps = bind_rows(df_samps_adult_lluvia,
                       df_samps_adult_seca,
                       df_samps_subadult_lluvia,
                       df_samps_subadult_seca) %>%
    mutate(bd_load = ifelse(bd_load < 0.3, 0, bd_load),
           log_bd_load = log(bd_load + 1),
           taxon_capture = species_name)
}

sample_posterior_life_1s = function(m_zln, species_name, n = 10000){
  ps_adult_lluvia = samp_pos(m_zln, "adult", "lluvia", n)
  ps_subadult_lluvia = samp_pos(m_zln, "subadult", "lluvia", n)

  df_samps_adult_lluvia = data.frame(
    life_stage_simple = "adult",
    season = "lluvia",
    bd_load = ps_adult_lluvia
  )

  df_samps_subadult_lluvia = data.frame(
    life_stage_simple = "subadult",
    season = "lluvia",
    bd_load = ps_subadult_lluvia
  )

  df_samps = bind_rows(df_samps_adult_lluvia,
                       df_samps_subadult_lluvia) %>%
    mutate(bd_load = ifelse(bd_load < 0.3, 0, bd_load),
           log_bd_load = log(bd_load + 1),
           taxon_capture = species_name)
}

simulate_bd_load = function(draws, n_per_draw = 10, downsample = NA) {
  if (!is.na(downsample) & downsample < length(unique(draws$.draw))) {
    draws = draws %>%
      group_by(taxon_capture, life_stage_simple) %>%
      slice_sample(n = downsample) %>%
      ungroup()
  }
  
  
  draws %>%
    filter(!is.na(b),
           !is.na(sigma)) %>%
    group_by(.draw, taxon_capture, life_stage_simple) %>%
    reframe(
      log_bd_load_co_density = rnorm(n_per_draw, mean = b, sd = sigma),
      .id = "sim_id"
    ) %>%
    ungroup()
}

wilson_ci = function(p_hat, n, conf.level = 0.95) {
  z <- qnorm(1 - (1 - conf.level) / 2)
  
  denominator <- 1 + (z^2 / n)
  centre_adjusted_probability <- p_hat + (z^2 / (2 * n))
  adjusted_standard_deviation <- sqrt((p_hat * (1 - p_hat) / n) + (z^2 / (4 * n^2)))
  
  lower_bound <- (centre_adjusted_probability - z * adjusted_standard_deviation) / denominator
  upper_bound <- (centre_adjusted_probability + z * adjusted_standard_deviation) / denominator
  
  return(c(lower_bound = lower_bound, upper_bound = upper_bound))
}

wilson_ci_lower = function(p_hat, n, conf.level = 0.95) {
  ws = wilson_ci(p_hat, n, conf.level)
  return(ws[1])
}

wilson_ci_upper = function(p_hat, n, conf.level = 0.95) {
  ws = wilson_ci(p_hat, n, conf.level)
  return(ws[2])
}

sample_stats = function(df) {
  df %>%
    group_by(taxon_capture,
             life_stage_simple) %>%
    summarise(n = n(),
              n_pos = sum(bd_load_co > 0),
              bd_prevalence = sum(bd_load_co > 0) / n(),
              bd_prevalence_ci_lower = wilson_ci_lower(bd_prevalence, n(), 0.95),
              bd_prevalence_ci_upper = wilson_ci_upper(bd_prevalence, n(), 0.95),
              min_log_pos_load_dens = min(log_bd_load_co_density[bd_load_co > 0]),
              q_25_log_pos_load_dens = quantile(log_bd_load_co_density[bd_load_co > 0], probs = 0.25),
              q_50_log_pos_load_dens = quantile(log_bd_load_co_density[bd_load_co > 0], probs = 0.50),
              q_75_log_pos_load_dens = quantile(log_bd_load_co_density[bd_load_co > 0], probs = 0.75),
              max_log_pos_load_dens = max(log_bd_load_co_density[bd_load_co > 0]),
              se = sqrt(bd_prevalence * (1 - bd_prevalence) / n),
              .groups = "drop") %>%
    mutate(label_y = case_match(life_stage_simple,
                                "adult" ~ .98,
                                "subadult" ~ .95))
}
# 
# plot_prev_obs = function(obs_stats, taxon) {
#   dodge_width = 0.5  # Adjust width as needed
#   
#   ggplot(obs_stats %>%
#            filter(taxon_capture == taxon), aes(y = bd_prevalence, color = life_stage_simple)) +
#     geom_point(position = position_dodge(width = dodge_width)) +   # dodge points side by side
#     geom_errorbar(aes(ymin = bd_prevalence_ci_lower, ymax = bd_prevalence_ci_upper),
#                   width = 0.2,
#                   position = position_dodge(width = dodge_width)) +  # dodge error bars side by side, same width
#     theme_minimal() +
#     ggtitle(paste0("Observed prevalence: ", species_name)) +
#     xlab("Season") +
#     ylab("Bd prevalence [-]\n(with 95% CI)") +
#     labs(color = "Life stage") +
#     geom_text(aes(label = paste0("n=", n)),
#               position = position_dodge(width = dodge_width + 0.5)) +  # dodge text labels similarly
#     ylim(0, 1)
# }
# 
# plot_prev_mod = function(draws_spec, species_name){
#   ggplot(draws_spec, aes(prevalence, x = season, color = life_stage_simple, linetype = season)) +
#     geom_boxplot(coef = NULL) + 
#     theme_minimal() +
#     ggtitle(paste0("Modeled prevalence: ", species_name)) +
#     xlab("Season") +
#     ylab("Bd prevalence [-]\n") +
#     labs(color = "Life stage") +
#     ylim(0, 1)
# }
# 
# plot_load_obs = function(bd_model_spec, obs_stats, species_name){
#   ggplot(bd_model_spec %>%
#            filter(bd_load > 0), aes(log_bd_load, x = season, color = life_stage_simple, linetype = season)) +
#     geom_boxplot() + 
#     theme_minimal() +
#     ggtitle(paste0("Observed Bd-positive load: ", spec_name)) +
#     xlab("Season") +
#     ylab("log(Bd load) [-]") +
#     labs(color = "Life stage") +
#     geom_text(
#       data = obs_stats,
#       aes(
#         x = season,
#         y = q_50_log_load_inf,
#         label = paste0("n=", n_pos),
#         group = life_stage_simple
#       ),
#       position = position_dodge(width = .75),
#       vjust = -0.25
#     ) +
#     ylim(log(0.3), 20)
# }
# 
# # plot_load_mod = function(draws_spec, species_name) {
# #   ggplot(draws_spec, aes(b, x = season, color = life_stage_simple, linetype = season)) +
# #     geom_boxplot() + 
# #     theme_minimal() +
# #     ggtitle(paste0("Modeled Bd-positive load: ", species_name)) +
# #     xlab("Season") +
# #     ylab("log(Bd load) [-]") +
# #     labs(color = "Life stage") +
# #     ylim(log(0.3), 15)
# # }
# 
# plot_load_mod = function(sim, species_name) {
#   ggplot(sim %>%
#            filter(log_bd_load > 0.3), aes(log_bd_load, x = season, color = life_stage_simple, linetype = season)) +
#     geom_boxplot() + 
#     theme_minimal() +
#     ggtitle(paste0("Modeled Bd-positive load: ", species_name)) +
#     xlab("Season") +
#     ylab("log(Bd load) [-]") +
#     labs(color = "Life stage") +
#     ylim(log(0.3), 20)
# }
# 
# plot_pdf = function(density_mat, species_name) {
#   ggplot(density_mat, aes(x = density,
#                           y = pdf_median,
#                           color = life_stage_simple, 
#                           fill = life_stage_simple,
#                           linetype = season)) +
#     geom_ribbon(aes(ymin = pdf_lower,
#                     ymax = pdf_upper), 
#                 alpha = 0.15,
#                 color = NA) +
#     geom_line() +
#     theme_minimal() +
#     ggtitle(paste0("PDF of Bd-positive load: ", species_name)) +
#     labs(color = "Life stage",
#          fill = "Life stage",
#          linetype = "Season") +
#     xlab("log(Bd load) [-]") +
#     ylab("Median probability density [-]\n(with 25th to 75th percentiles)") +
#     scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0))
# }
# 
# plot_ccdf = function(density_mat, species_name) {
#   ggplot(density_mat, aes(x = density,
#                           y = ccdf_median,
#                           color = life_stage_simple, 
#                           fill = life_stage_simple,
#                           linetype = season)) +
#     geom_ribbon(aes(ymin = ccdf_lower,
#                     ymax = ccdf_upper), 
#                 alpha = 0.15,
#                 color = NA) +
#     geom_line() +
#     theme_minimal() +
#     ggtitle(paste0("CCDF of Bd-positive load: ", species_name)) +
#     labs(color = "Life stage",
#          fill = "Life stage",
#          linetype = "Season") +
#     xlab("log(Bd load) [-]") +
#     ylab("Median complementary cumulative density (1 - CDF) [-]\n(with 25th to 75th percentiles)") +
#     scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0)) +
#     ylim(0, 1)
# }

```

# Results
Results are broken out first by species, then combined for comparison between species

## Collective results
```{r}
#| eval: true
#| echo: true
#| output: false
#| code-fold: true
#| code-summary: Show Colostethus panamansis code

m_zln_all = readRDS("model_results_zln_life_tax_pop_unified.rds")

draws_all = collect_draws(m_zln_all) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

density_mat_all = density_mat(log(0.5), 20, 100, draws_all) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

sim_load_all = simulate_bd_load(draws_all, 10, 1000) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

obs_stats_all = sample_stats(bd_model) %>%
  mutate(species = get_species_name(taxon_capture, newline = TRUE))

# summary(m_zln_all)
# model_report(m_zln_all)

```

::: {.panel-tabset}
### Observed Prevalence
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# observed prevalence
ggplot(obs_stats_all, aes(y = bd_prevalence, x = species, color = life_stage_simple)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = bd_prevalence_ci_lower, ymax = bd_prevalence_ci_upper),
                width = 0.2,
                position = position_dodge(width = 0.5)) +
  theme_minimal() +
  ggtitle("Observed prevalence") +
  xlab("Species") +
  ylab("Bd prevalence [-]\n(with 95% CI)") +
  labs(color = "Life stage") +
  geom_text(aes(label = paste0("n=", n),  y = label_y),
          position = position_dodge(width = 0.5)) +
  ylim(0, 1)
```

### Modeled Prevalence 
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# model prevalence
ggplot(draws_all, aes(prevalence, x = species, color = life_stage_simple)) +
  geom_boxplot(coef = NULL) + 
  theme_minimal() +
  ggtitle("Modeled prevalence") +
  xlab("Species") +
  ylab("Bd prevalence [-]\n") +
  labs(color = "Life stage") +
  ylim(0, 1)
```

### Observed Bd load
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# obsevation bd load
ggplot(bd_model %>%
         mutate(species = get_species_name(taxon_capture, newline = TRUE)) %>%
         filter(bd_load_co > 0), aes(log_bd_load_co_density, x = species, color = life_stage_simple)) +
  geom_boxplot() + 
  theme_minimal() +
  ggtitle("Observed Bd-positive load") +
  xlab("Species") +
  ylab("log(Bd load density) [-]") +
  labs(color = "Life stage") +
  geom_text(
    data = obs_stats_all,
    aes(
      x = species,
      y = max(bd_model$log_bd_load_co_density) * label_y * 1.05,
      label = paste0("n=", n_pos),
      group = life_stage_simple
    ),
    position = position_dodge(width = 0.75),
    vjust = 0
  ) +
  ylim(log(0.5), 18)
```

### Modeled Bd load
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# modeled bd load
ggplot(sim_load_all %>%
         filter(log_bd_load_co_density > 0.5), aes(log_bd_load_co_density, x = species, color = life_stage_simple)) +
  geom_boxplot() + 
  theme_minimal() +
  ggtitle("Modeled Bd-positive load") +
  xlab("Species") +
  ylab("log(Bd load density) [-]") +
  labs(color = "Life stage") +
  ylim(log(0.5), 20)
```

### Modeled Bd load PDF
```{r}
#| echo: false
#| warning: false
#| fig-width: 12
#| fig-height: 6
# PDF -- facet by species
ggplot(density_mat_all, aes(x = density,
                            y = pdf_median,
                            color = life_stage_simple, 
                            fill = life_stage_simple)) +
  geom_ribbon(aes(ymin = pdf_lower,
                  ymax = pdf_upper), 
              alpha = 0.15,
              color = NA) +
  geom_line() +
  theme_minimal() +
  ggtitle("Modeled PDF of Bd-positive load") +
  labs(color = "Life stage",
       fill = "Life stage") +
  xlab("log(Bd load) [-]") +
  ylab("Median probability density [-]\n(with 25th to 75th percentiles)") +
  scale_x_continuous(limits = c(log(0.5), 20), expand = c(0, 0)) +
  facet_grid(. ~ gsub(" ", "\n", species))

# # PDF -- facet by life_stage & season
# ggplot(density_mat_all, aes(x = density,
#                             y = pdf_median,
#                             color = taxon_capture, 
#                             fill = taxon_capture)) +
#   geom_ribbon(aes(ymin = pdf_lower,
#                   ymax = pdf_upper), 
#               alpha = 0.15,
#               color = NA) +
#   geom_line() +
#   theme_minimal() +
#   ggtitle("Modeled PDF of Bd-positive load") +
#   labs(color = "Species",
#        fill = "Species") +
#   xlab("log(Bd load) [-]") +
#   ylab("Median probability density [-]\n(with 25th to 75th percentiles)") +
#   scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0)) +
#   facet_grid(life_stage_simple ~ season)
```

### Moded Bd load CCDF
```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 12
# CCDF -- facet by species
ggplot(density_mat_all, aes(x = density,
                            y = ccdf_median,
                            color = life_stage_simple, 
                            fill = life_stage_simple)) +
  geom_ribbon(aes(ymin = ccdf_lower,
                  ymax = ccdf_upper), 
              alpha = 0.15,
              color = NA) +
  geom_line() +
  theme_minimal() +
  ggtitle("Modeled CCDF of Bd-positive load") +
  labs(color = "Life stage",
       fill = "Life stage") +
  xlab("log(Bd load) [-]") +
  ylab("Median complementary cumulative density (1 - CDF) [-]\n(with 25th to 75th percentiles)") +
  scale_x_continuous(limits = c(log(0.5), 20), expand = c(0, 0)) +
  ylim(0, 1) +
  facet_grid(. ~ gsub(" ", "\n", species))

# # CCDF -- facet by life_stage & season
# ggplot(density_mat_all, aes(x = density,
#                             y = ccdf_median,
#                             color = taxon_capture, 
#                             fill = taxon_capture)) +
#   geom_ribbon(aes(ymin = ccdf_lower,
#                   ymax = ccdf_upper), 
#               alpha = 0.15,
#               color = NA) +
#   geom_line() +
#   theme_minimal() +
#   ggtitle("Modeled CCDF of Bd-positive load") +
#   labs(color = "Species",
#        fill = "Species") +
#   xlab("log(Bd load) [-]") +
#   ylab("Median complementary cumulative density (1 - CDF) [-]\n(with 25th to 75th percentiles)") +
#   scale_x_continuous(limits = c(log(0.3), 20), expand = c(0, 0)) +
#   ylim(0, 1) +
#   facet_grid(life_stage_simple ~ season)
```
:::

# Discussion
  - General patterns
    - Lluvia (wet) season:
      - Most species show greater Bd prevalence in juveniles, with some showing no distinct pattern (*A. varius* an exception)
      - Some species show greater Bd-positive load in juveniles, with most showing no distinct pattern (*A. varius* an exception)
    - Across seasons:
      - *C. panamansis*, *L. warszewitschii*, & *S. flotator* show generally stronger patterns of Bd prevalence with life stage in the wet season, compared with dry (*R. haemataticus* showing the opposite pattern)
      - Loads generally appear similar in the dry season, not necesarily in the wet season
  - Bringing in more context
    - Discuss in the context of species characteristics (Lips et al. 2003)
      - habitat and development (aquatic vs. terrestrial)
      - elevation range
      - population/region
      - species body size (in general)
      - activity period
    - How does seasonal behavior impact species trends (e.g. gathering around puddles - Ana Longo)
    - Effects of air humidity on Bd growth (e.g. Jordan Gas & Jaimem, 2022)
 
# Next steps:
  - Confirm data selection & models
    - utility for case of *A. varius*?
    - discuss case of *R. marina* (0 positive Bd load obs)
  - Quantitative hypothesis testing (model comparisons, etc.)
  - Other ideas?
 